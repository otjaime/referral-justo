<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Justo - Programa de Referidos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            justo: {
              50: '#f5f3ff', 100: '#ede9fe', 200: '#ddd6fe', 300: '#c4b5fd',
              400: '#a78bfa', 500: '#7c3aed', 600: '#6d28d9', 700: '#5b21b6',
              800: '#4c1d95', 900: '#3b0764',
            },
            ocean: {
              50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd',
              400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8',
            }
          }
        }
      }
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; background: #050510; color: #e2e2ea; }

    .input-dark {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      color: #f1f1f6;
      border-radius: 0.75rem;
      padding: 0.625rem 0.875rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      width: 100%;
      font-size: 0.875rem;
    }
    .input-dark::placeholder { color: rgba(255,255,255,0.25); }
    .input-dark:focus { border-color: rgba(124,58,237,0.4); box-shadow: 0 0 0 3px rgba(124,58,237,0.1); }
    .input-dark-lg { font-size: 1.125rem; padding: 0.75rem 1rem; }

    .btn-primary {
      background: linear-gradient(135deg, #7c3aed, #6d28d9);
      color: white; font-weight: 600;
      padding: 0.625rem 1.25rem; border-radius: 0.75rem;
      transition: all 0.2s; position: relative; overflow: hidden;
      border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
    }
    .btn-primary:hover { box-shadow: 0 0 24px rgba(124,58,237,0.3); transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.5; transform: none; box-shadow: none; cursor: not-allowed; }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    /* ─── Spotlight Card: mouse-tracking radial glow ─── */
    .spotlight-card {
      position: relative;
      overflow: hidden;
      border-radius: 1rem;
      transition: border-color 0.3s, transform 0.2s;
    }
    .spotlight-card::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(
        350px circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
        var(--spotlight-color, rgba(124,58,237,0.10)),
        transparent 70%
      );
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: 1;
    }
    .spotlight-card:hover::after { opacity: 1; }
    .spotlight-card:hover { transform: translateY(-2px); border-color: rgba(124,58,237,0.2); }

    /* ─── Animated Beams: falling gradient lines ─── */
    @keyframes beamFall {
      0% { transform: translateY(-120vh); opacity: 0; }
      3% { opacity: 1; }
      97% { opacity: 0.8; }
      100% { transform: translateY(120vh); opacity: 0; }
    }
    .beam {
      position: absolute;
      top: 0;
      width: 1px;
      pointer-events: none;
      background: linear-gradient(180deg, transparent 0%, var(--beam-color-1, rgba(124,58,237,0.5)) 30%, var(--beam-color-2, rgba(59,130,246,0.3)) 70%, transparent 100%);
      animation: beamFall var(--beam-duration, 8s) linear var(--beam-delay, 0s) infinite;
    }

    /* ─── Animated Gradient Border ─── */
    @property --angle { syntax: '<angle>'; initial-value: 0deg; inherits: false; }
    @keyframes borderSpin { to { --angle: 360deg; } }
    .gradient-border {
      position: relative;
      border-radius: 1rem;
      padding: 2px;
      background: conic-gradient(from var(--angle), #7c3aed, #3b82f6, #06b6d4, #10b981, #7c3aed);
      animation: borderSpin 4s linear infinite;
    }
    .gradient-border-inner {
      border-radius: calc(1rem - 2px);
      background: linear-gradient(135deg, #1e1b4b 0%, #0f172a 100%);
    }

    /* ─── Glow Pulse ─── */
    @keyframes glowPulse {
      0%, 100% { box-shadow: 0 0 15px rgba(124,58,237,0.10), 0 0 30px rgba(59,130,246,0.05); }
      50% { box-shadow: 0 0 30px rgba(124,58,237,0.25), 0 0 60px rgba(59,130,246,0.10); }
    }
    .glow-card { animation: glowPulse 3s ease-in-out infinite; }

    /* ─── Floating Orbs ─── */
    @keyframes orbFloat1 { 0%,100% { transform: translate(0,0) scale(1); } 33% { transform: translate(40px,-30px) scale(1.05); } 66% { transform: translate(-20px,20px) scale(0.95); } }
    @keyframes orbFloat2 { 0%,100% { transform: translate(0,0) scale(1); } 33% { transform: translate(-30px,25px) scale(0.95); } 66% { transform: translate(25px,-35px) scale(1.05); } }
    @keyframes orbFloat3 { 0%,100% { transform: translate(0,0) scale(1); } 50% { transform: translate(15px,30px) scale(1.08); } }

    /* ─── Glass ─── */
    .glass { background: rgba(255,255,255,0.04); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid rgba(255,255,255,0.06); border-radius: 1rem; }

    /* ─── Shimmer / Skeleton Loading ─── */
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
    .shimmer {
      background: linear-gradient(90deg, transparent 25%, rgba(255,255,255,0.08) 50%, transparent 75%);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
    }

    /* ─── Gradient Text ─── */
    .text-gradient {
      background: linear-gradient(135deg, #7c3aed, #3b82f6, #06b6d4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* ─── Active Nav Glow ─── */
    .nav-glow { box-shadow: inset 3px 0 12px -4px rgba(124,58,237,0.5); }

    /* ─── Badge Glow ─── */
    @keyframes badgeGlow {
      0%, 100% { box-shadow: 0 0 8px rgba(124,58,237,0.0); }
      50% { box-shadow: 0 0 16px var(--badge-glow, rgba(124,58,237,0.3)); }
    }
    .badge-earned { animation: badgeGlow 2.5s ease-in-out infinite; }

    /* ─── Noise Texture (inline SVG) ─── */
    .noise { position: relative; }
    .noise::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      opacity: 0.025;
      pointer-events: none;
      z-index: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
    }
  </style>
</head>
<body class="min-h-screen">
  <div id="root"></div>

  <script>
    window.onerror = function(msg, url, line, col) {
      document.getElementById('root').innerHTML = '<pre style="color:red;padding:20px;font-size:14px">' + msg + '\nat ' + url + ':' + line + ':' + col + '</pre>';
    };
  </script>
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/htm@3.1.1/dist/htm.js"></script>

  <script>
    var html = htm.bind(React.createElement);
    var useState = React.useState, useEffect = React.useEffect, useContext = React.useContext,
        createContext = React.createContext, useRef = React.useRef;

    // ─── Simple Hash Router ─────────────────────────────
    function useHash() {
      var _s = useState(window.location.hash.slice(1) || '/');
      var hash = _s[0], setHash = _s[1];
      useEffect(function() {
        function onHash() { setHash(window.location.hash.slice(1) || '/'); }
        window.addEventListener('hashchange', onHash);
        return function() { window.removeEventListener('hashchange', onHash); };
      }, []);
      return hash;
    }
    function navigate(path) { window.location.hash = path; }

    // ─── CLP Formatter ─────────────────────────────────
    function formatCLP(amount) {
      return '$' + Number(amount).toLocaleString('es-CL');
    }

    // ─── API Helper ──────────────────────────────────────
    function api(path, options) {
      options = options || {};
      var token = localStorage.getItem('justo_token');
      var config = {
        headers: Object.assign({ 'Content-Type': 'application/json' }, token ? { Authorization: 'Bearer ' + token } : {}),
      };
      Object.keys(options).forEach(function(k) {
        if (k === 'headers') config.headers = Object.assign(config.headers, options.headers);
        else config[k] = options[k];
      });
      return fetch(path, config).then(function(res) {
        return res.json().then(function(data) {
          if (!res.ok) {
            if (res.status === 401) {
              localStorage.removeItem('justo_token');
              localStorage.removeItem('justo_user');
              navigate('/login');
            }
            throw new Error((data.error && data.error.message) || 'Error del servidor');
          }
          return data;
        });
      });
    }

    // ─── Auth Context ────────────────────────────────────
    var AuthContext = createContext(null);

    function AuthProvider(props) {
      var _u = useState(null), user = _u[0], setUser = _u[1];
      var _t = useState(null), token = _t[0], setToken = _t[1];
      var _l = useState(true), loading = _l[0], setLoading = _l[1];

      useEffect(function() {
        var t = localStorage.getItem('justo_token');
        var u = localStorage.getItem('justo_user');
        if (t && u) { setToken(t); setUser(JSON.parse(u)); }
        setLoading(false);
      }, []);

      function login(userData, tokenStr) {
        setUser(userData); setToken(tokenStr);
        localStorage.setItem('justo_token', tokenStr);
        localStorage.setItem('justo_user', JSON.stringify(userData));
      }
      function logout() {
        setUser(null); setToken(null);
        localStorage.removeItem('justo_token');
        localStorage.removeItem('justo_user');
      }

      return html`<${AuthContext.Provider} value=${{ user: user, token: token, loading: loading, login: login, logout: logout, isAdmin: user && user.role === 'ADMIN' }}>
        ${props.children}
      </${AuthContext.Provider}>`;
    }

    function useAuth() { return useContext(AuthContext); }

    // ─── Toast Context ───────────────────────────────────
    var ToastContext = createContext(null);

    function ToastProvider(props) {
      var _s = useState([]), toasts = _s[0], setToasts = _s[1];
      function addToast(message, type) {
        type = type || 'success';
        var id = Date.now();
        setToasts(function(prev) { return prev.concat([{ id: id, message: message, type: type }]); });
        setTimeout(function() { setToasts(function(prev) { return prev.filter(function(t) { return t.id !== id; }); }); }, 4000);
      }
      return html`<${ToastContext.Provider} value=${{ addToast: addToast }}>
        ${props.children}
        <div className="fixed top-4 right-4 z-50 space-y-2">
          ${toasts.map(function(t) {
            var borderColor = t.type === 'error' ? 'border-l-red-500' : t.type === 'warning' ? 'border-l-yellow-500' : 'border-l-emerald-500';
            var icon = t.type === 'error' ? 'M6 18L18 6M6 6l12 12' : t.type === 'warning' ? 'M12 9v2m0 4h.01' : 'M5 13l4 4L19 7';
            var iconColor = t.type === 'error' ? 'text-red-400' : t.type === 'warning' ? 'text-yellow-400' : 'text-emerald-400';
            return html`<div key=${t.id} className=${'fade-in glass px-4 py-3 rounded-xl border-l-4 flex items-center gap-2.5 ' + borderColor}>
              <svg className=${'h-4 w-4 flex-shrink-0 ' + iconColor} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d=${icon}/></svg>
              <span className="text-sm font-medium text-white/90">${t.message}</span>
            </div>`;
          })}
        </div>
      </${ToastContext.Provider}>`;
    }

    function useToast() { return useContext(ToastContext); }

    // ─── Utility Components ──────────────────────────────
    function StatusBadge(props) {
      var map = {
        PENDING: ['Pendiente', 'bg-yellow-500/15 text-yellow-300 border border-yellow-500/20'],
        QUALIFIED: ['Calificado', 'bg-blue-500/15 text-blue-300 border border-blue-500/20'],
        REWARDED: ['Recompensado', 'bg-emerald-500/15 text-emerald-300 border border-emerald-500/20'],
        EXPIRED: ['Expirado', 'bg-gray-500/15 text-gray-400 border border-gray-500/20'],
        ISSUED: ['Disponible', 'bg-emerald-500/15 text-emerald-300 border border-emerald-500/20'],
        REDEEMED: ['Canjeado', 'bg-blue-500/15 text-blue-300 border border-blue-500/20'],
      };
      var entry = map[props.status] || [props.status, 'bg-gray-500/15 text-gray-400 border border-gray-500/20'];
      return html`<span className=${'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ' + entry[1]}>${entry[0]}</span>`;
    }

    function Spinner(props) {
      var cls = props.className || 'h-5 w-5';
      return html`<svg className=${'animate-spin ' + cls} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>`;
    }

    function LoadingScreen() {
      return html`<div className="flex items-center justify-center h-screen">
        <div className="relative">
          <div className="w-12 h-12 rounded-full border-2 border-white/10 border-t-justo-500 animate-spin" />
        </div>
        <span className="ml-4 text-gray-400 text-sm">Cargando...</span>
      </div>`;
    }

    function EmptyState(props) {
      return html`<div className="text-center py-12">
        <div className="text-gray-600 mb-4"><svg className="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg></div>
        <h3 className="text-lg font-medium text-white">${props.title}</h3>
        <p className="text-gray-500 mt-1 text-sm">${props.description}</p>
      </div>`;
    }

    // ─── Nav Link ─────────────────────────────────────────
    function NavLink(props) {
      return html`<a href=${'#' + props.to} onClick=${props.onClick || null}
        className=${props.className}>${props.children}</a>`;
    }

    // ─── SpotlightCard ─────────────────────────────────────
    function SpotlightCard(props) {
      var ref = useRef(null);
      useEffect(function() {
        var el = ref.current;
        if (!el) return;
        function onMove(e) {
          var rect = el.getBoundingClientRect();
          el.style.setProperty('--mouse-x', (e.clientX - rect.left) + 'px');
          el.style.setProperty('--mouse-y', (e.clientY - rect.top) + 'px');
        }
        el.addEventListener('mousemove', onMove);
        return function() { el.removeEventListener('mousemove', onMove); };
      }, []);
      return html`<div ref=${ref} className=${'spotlight-card glass ' + (props.className || '')} style=${props.style || {}}>
        <div className="relative z-[2] p-5">${props.children}</div>
      </div>`;
    }

    // ─── AnimatedCounter ─────────────────────────────────────
    function AnimatedCounter(props) {
      var _v = useState(0), val = _v[0], setVal = _v[1];
      var target = props.value || 0;
      var duration = props.duration || 1200;
      useEffect(function() {
        if (target === 0) { setVal(0); return; }
        var startTime = null;
        var raf;
        function step(timestamp) {
          if (!startTime) startTime = timestamp;
          var progress = Math.min((timestamp - startTime) / duration, 1);
          var eased = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
          setVal(Math.round(eased * target));
          if (progress < 1) raf = requestAnimationFrame(step);
        }
        raf = requestAnimationFrame(step);
        return function() { cancelAnimationFrame(raf); };
      }, [target]);
      return props.format ? props.format(val) : val;
    }

    // ─── BackgroundBeams ─────────────────────────────────────
    function BackgroundBeams() {
      var beams = [
        { left: '10%', height: '70vh', duration: '7s', delay: '0s' },
        { left: '25%', height: '50vh', duration: '9s', delay: '2s' },
        { left: '45%', height: '80vh', duration: '11s', delay: '1s' },
        { left: '65%', height: '60vh', duration: '8s', delay: '3s' },
        { left: '80%', height: '55vh', duration: '10s', delay: '0.5s' },
        { left: '92%', height: '65vh', duration: '12s', delay: '4s' },
      ];
      return html`<div className="fixed inset-0 overflow-hidden pointer-events-none z-0" style=${{ opacity: 0.4 }}>
        ${beams.map(function(b, i) {
          return html`<div key=${i} className="beam" style=${{ left: b.left, height: b.height, '--beam-duration': b.duration, '--beam-delay': b.delay }} />`;
        })}
      </div>`;
    }

    // ─── FloatingOrbs ─────────────────────────────────────
    function FloatingOrbs() {
      return html`<div className="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div className="absolute top-1/4 left-1/4 w-96 h-96 rounded-full blur-[100px]" style=${{ background: 'rgba(124,58,237,0.07)', animation: 'orbFloat1 20s ease-in-out infinite' }} />
        <div className="absolute bottom-1/3 right-1/4 w-72 h-72 rounded-full blur-[80px]" style=${{ background: 'rgba(59,130,246,0.06)', animation: 'orbFloat2 25s ease-in-out infinite' }} />
        <div className="absolute top-2/3 left-1/2 w-48 h-48 rounded-full blur-[60px]" style=${{ background: 'rgba(167,139,250,0.04)', animation: 'orbFloat3 18s ease-in-out infinite' }} />
      </div>`;
    }

    // ─── Error Boundary ─────────────────────────────────────
    var ErrorBoundary = (function() {
      function EB(props) {
        var _s = useState(null), error = _s[0], setError = _s[1];
        useEffect(function() {
          function handler(event) {
            setError(event.error || new Error(event.message || 'Error desconocido'));
          }
          window.addEventListener('error', handler);
          return function() { window.removeEventListener('error', handler); };
        }, []);
        if (error) {
          return html`<div className="flex items-center justify-center h-screen p-8">
            <div className="glass rounded-2xl p-8 max-w-md text-center">
              <div className="text-red-400 mb-4">
                <svg className="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
              </div>
              <h2 className="text-xl font-bold text-white mb-2">Algo salio mal</h2>
              <p className="text-gray-400 text-sm mb-4">${error.message}</p>
              <button onClick=${function() { setError(null); window.location.hash = '/'; window.location.reload(); }} className="btn-primary px-6 py-2">Recargar</button>
            </div>
          </div>`;
        }
        return props.children;
      }
      return EB;
    })();

    // ─── Skeleton Loader ─────────────────────────────────────
    function SkeletonCard(props) {
      var rows = props.rows || 3;
      var items = [];
      for (var i = 0; i < rows; i++) items.push(i);
      return html`<div className="spotlight-card glass">
        <div className="relative z-[2] p-5 space-y-4" role="status" aria-label="Cargando">
          <div className="h-5 w-1/3 rounded shimmer" />
          ${items.map(function(i) {
            return html`<div key=${i} className="space-y-2">
              <div className="h-3 w-full rounded shimmer" />
              <div className="h-3 rounded shimmer" style=${{ width: (60 + Math.random() * 30) + '%' }} />
            </div>`;
          })}
          <span className="sr-only">Cargando contenido...</span>
        </div>
      </div>`;
    }

    function SkeletonGrid(props) {
      var cols = props.cols || 3;
      var items = [];
      for (var i = 0; i < cols; i++) items.push(i);
      return html`<div className=${'grid gap-4 ' + (cols === 4 ? 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-4' : 'grid-cols-1 sm:grid-cols-3')}>
        ${items.map(function(i) {
          return html`<${SkeletonCard} key=${i} rows=${2} />`;
        })}
      </div>`;
    }

    // ─── Pagination ─────────────────────────────────────────
    function Pagination(props) {
      var page = props.page;
      var total = props.total;
      var perPage = props.perPage || 10;
      var totalPages = Math.ceil(total / perPage);
      if (totalPages <= 1) return null;
      var setPage = props.onPageChange;
      var pages = [];
      var start = Math.max(1, page - 2);
      var end = Math.min(totalPages, page + 2);
      for (var i = start; i <= end; i++) pages.push(i);
      return html`<nav className="flex items-center justify-center gap-1 mt-4 pt-4 border-t border-white/[0.06]" role="navigation" aria-label="Paginacion">
        <button onClick=${function() { setPage(Math.max(1, page - 1)); }} disabled=${page === 1}
          className="px-3 py-1.5 rounded-lg text-sm text-gray-400 hover:bg-white/5 disabled:opacity-30 disabled:cursor-not-allowed transition-colors" aria-label="Pagina anterior">
          <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 19l-7-7 7-7"/></svg>
        </button>
        ${pages.map(function(p) {
          return html`<button key=${p} onClick=${function() { setPage(p); }}
            className=${'px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ' + (p === page ? 'bg-justo-500 text-white' : 'text-gray-400 hover:bg-white/5')}
            aria-current=${p === page ? 'page' : undefined} aria-label=${'Pagina ' + p}>${p}</button>`;
        })}
        <button onClick=${function() { setPage(Math.min(totalPages, page + 1)); }} disabled=${page === totalPages}
          className="px-3 py-1.5 rounded-lg text-sm text-gray-400 hover:bg-white/5 disabled:opacity-30 disabled:cursor-not-allowed transition-colors" aria-label="Pagina siguiente">
          <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5l7 7-7 7"/></svg>
        </button>
        <span className="ml-3 text-xs text-gray-500">${total} resultados</span>
      </nav>`;
    }

    // ─── Search Input ─────────────────────────────────────────
    function SearchInput(props) {
      return html`<div className="relative">
        <svg className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        <input type="search" value=${props.value} onInput=${props.onInput}
          className="input-dark pl-10" placeholder=${props.placeholder || 'Buscar...'} aria-label=${props.placeholder || 'Buscar'} />
      </div>`;
    }

    // ─── Password Strength Indicator ─────────────────────────
    function PasswordStrength(props) {
      var pw = props.value || '';
      if (!pw) return null;
      var score = 0;
      if (pw.length >= 8) score++;
      if (/[A-Z]/.test(pw)) score++;
      if (/[a-z]/.test(pw)) score++;
      if (/[0-9]/.test(pw)) score++;
      if (/[^A-Za-z0-9]/.test(pw)) score++;
      var labels = ['Muy debil', 'Debil', 'Regular', 'Buena', 'Fuerte'];
      var colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-blue-500', 'bg-emerald-500'];
      var idx = Math.min(score, 4);
      return html`<div className="mt-1.5">
        <div className="flex gap-1">
          ${[0,1,2,3,4].map(function(i) {
            return html`<div key=${i} className=${'h-1 flex-1 rounded-full transition-colors ' + (i <= idx ? colors[idx] : 'bg-white/10')} />`;
          })}
        </div>
        <p className="text-xs text-gray-500 mt-0.5">${labels[idx]}</p>
      </div>`;
    }

    // ─── Clipboard Helper ─────────────────────────────────────
    function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(text);
      }
      return new Promise(function(resolve, reject) {
        try {
          var ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          resolve();
        } catch (e) { reject(e); }
      });
    }

    // ─── Auth Page ───────────────────────────────────────
    function AuthPage() {
      var auth = useAuth();
      var _m = useState('login'), mode = _m[0], setMode = _m[1];
      var _f = useState({ name: '', email: '', password: '' }), form = _f[0], setForm = _f[1];
      var _ld = useState(false), loading = _ld[0], setLoading = _ld[1];
      var _e = useState(''), error = _e[0], setError = _e[1];
      var toast = useToast();

      if (auth.user) { navigate('/'); return null; }

      function handleSubmit(e) {
        e.preventDefault();
        setError(''); setLoading(true);
        var endpoint = mode === 'login' ? '/auth/login' : '/auth/register';
        var body = mode === 'login' ? { email: form.email, password: form.password } : form;
        api(endpoint, { method: 'POST', body: JSON.stringify(body) })
          .then(function(data) {
            auth.login(data.user, data.token);
            toast.addToast(mode === 'login' ? 'Bienvenido de vuelta!' : 'Cuenta creada exitosamente!');
            navigate('/');
          })
          .catch(function(err) { setError(err.message); })
          .finally(function() { setLoading(false); });
      }

      return html`<div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
        <${BackgroundBeams} />
        <${FloatingOrbs} />
        <div className="w-full max-w-md relative z-10">
          <div className="text-center mb-8">
            <h1 className="text-4xl font-bold text-gradient">Justo</h1>
            <p className="text-gray-400 mt-2">Programa de Referidos</p>
          </div>
          <div className="glass rounded-2xl p-8">
            <div className="flex rounded-lg p-1 mb-6" style=${{ background: 'rgba(255,255,255,0.06)' }}>
              <button onClick=${function() { setMode('login'); setError(''); }} className=${'flex-1 py-2 text-sm font-medium rounded-md transition-colors ' + (mode === 'login' ? 'bg-white/10 text-white shadow' : 'text-gray-500')}>Iniciar Sesion</button>
              <button onClick=${function() { setMode('register'); setError(''); }} className=${'flex-1 py-2 text-sm font-medium rounded-md transition-colors ' + (mode === 'register' ? 'bg-white/10 text-white shadow' : 'text-gray-500')}>Registrarse</button>
            </div>
            <form onSubmit=${handleSubmit} className="space-y-4">
              ${mode === 'register' && html`<div>
                <label className="block text-sm font-medium text-gray-300 mb-1">Nombre</label>
                <input type="text" required value=${form.name} onInput=${function(e) { setForm(Object.assign({}, form, { name: e.target.value })); }} className="input-dark" placeholder="Tu nombre" />
              </div>`}
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1">Email</label>
                <input type="email" required value=${form.email} onInput=${function(e) { setForm(Object.assign({}, form, { email: e.target.value })); }} className="input-dark" placeholder="tu@email.com" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1">Contrasena</label>
                <input type="password" required minLength=${8} value=${form.password} onInput=${function(e) { setForm(Object.assign({}, form, { password: e.target.value })); }} className="input-dark" placeholder="Min. 8 caracteres" aria-describedby="pw-strength" />
                ${mode === 'register' && html`<${PasswordStrength} value=${form.password} />`}
              </div>
              ${error && html`<p className="text-red-400 text-sm" role="alert">${error}</p>`}
              <button type="submit" disabled=${loading} className="w-full btn-primary py-2.5">
                ${loading ? html`<${Spinner} className="h-5 w-5" />` : (mode === 'login' ? 'Iniciar Sesion' : 'Crear Cuenta')}
              </button>
            </form>
          </div>
        </div>
      </div>`;
    }

    // ─── Dashboard ───────────────────────────────────────
    function Dashboard() {
      var auth = useAuth();
      var toast = useToast();
      var _c = useState(null), code = _c[0], setCode = _c[1];
      var _s = useState([]), sent = _s[0], setSent = _s[1];
      var _r = useState([]), rewards = _r[0], setRewards = _r[1];
      var _rk = useState(null), rank = _rk[0], setRank = _rk[1];
      var _l = useState(true), loading = _l[0], setLoading = _l[1];

      useEffect(function() {
        Promise.all([api('/referrals/my-code'), api('/referrals/sent'), api('/rewards'), api('/analytics/my-rank')])
          .then(function(res) { setCode(res[0]); setSent(res[1]); setRewards(res[2]); setRank(res[3]); })
          .catch(function(err) { toast.addToast('Error al cargar datos', 'error'); })
          .finally(function() { setLoading(false); });
      }, []);

      function copyCode() {
        if (!code) return;
        var link = window.location.origin + '/#/invite/' + code.code;
        copyToClipboard(link).then(function() { toast.addToast('Link copiado!'); }).catch(function() { toast.addToast('No se pudo copiar', 'error'); });
      }

      function shareWhatsApp() {
        if (!code) return;
        var link = window.location.origin + '/#/invite/' + code.code;
        var msg = 'Te invito a unirte a Justo! Registra tu restaurante con mi link: ' + link;
        window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
      }

      function shareEmail() {
        if (!code) return;
        var link = window.location.origin + '/#/invite/' + code.code;
        var subject = 'Te invito a Justo - Programa de Referidos';
        var body = 'Hola!\n\nTe invito a registrar tu restaurante en Justo. Usa mi link de referido para obtener beneficios:\n\n' + link + '\n\nSaludos!';
        window.location.href = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
      }

      if (loading) return html`<div className="space-y-6">
        <div className="h-8 w-48 rounded shimmer" />
        <${SkeletonCard} rows=${2} />
        <${SkeletonGrid} cols=${4} />
        <${SkeletonCard} rows=${3} />
      </div>`;

      var activeRewards = rewards.filter(function(r) { return r.status === 'ISSUED'; }).length;
      var redeemedRewards = rewards.filter(function(r) { return r.status === 'REDEEMED'; }).length;
      var totalEarned = rewards.filter(function(r) { return r.beneficiaryType === 'REFERRER'; }).reduce(function(sum, r) { return sum + (r.amount || 0); }, 0);

      // Mini funnel data
      var funnelSent = sent.length;
      var funnelQualified = sent.filter(function(r) { return r.status === 'QUALIFIED' || r.status === 'REWARDED'; }).length;
      var funnelRewarded = sent.filter(function(r) { return r.status === 'REWARDED'; }).length;

      // Milestone logic
      var qualifiedCount = funnelQualified;
      var milestoneLevel, milestoneLabel, milestoneNext, milestoneProgress;
      if (qualifiedCount >= 10) { milestoneLevel = 'Embajador Justo'; milestoneLabel = 'Has alcanzado el maximo nivel!'; milestoneNext = 0; milestoneProgress = 100; }
      else if (qualifiedCount >= 5) { milestoneLevel = 'Top Referidor'; milestoneLabel = 'Faltan ' + (10 - qualifiedCount) + ' referidos exitosos para Embajador'; milestoneNext = 10; milestoneProgress = Math.round((qualifiedCount / 10) * 100); }
      else if (qualifiedCount >= 3) { milestoneLevel = 'Vas por buen camino'; milestoneLabel = 'Faltan ' + (5 - qualifiedCount) + ' referidos exitosos para Top Referidor'; milestoneNext = 5; milestoneProgress = Math.round((qualifiedCount / 5) * 100); }
      else if (qualifiedCount >= 1) { milestoneLevel = 'Tu primer referido!'; milestoneLabel = 'Faltan ' + (3 - qualifiedCount) + ' referidos exitosos para el siguiente nivel'; milestoneNext = 3; milestoneProgress = Math.round((qualifiedCount / 3) * 100); }
      else { milestoneLevel = 'Comienza a referir'; milestoneLabel = 'Comparte tu codigo para ganar recompensas'; milestoneNext = 1; milestoneProgress = 0; }

      return html`<div className="space-y-6">
        <h2 className="text-2xl font-bold text-gradient">Hola, ${auth.user.name}</h2>

        <div className="gradient-border glow-card">
          <div className="gradient-border-inner p-6">
            <p className="text-sm text-gray-400 mb-2">Tu codigo de referido</p>
            <div className="flex items-center justify-between flex-wrap gap-4">
              <span className="text-3xl md:text-4xl font-bold tracking-wider text-white">${code ? code.code : '...'}</span>
              <div className="flex gap-2 flex-wrap">
                <button onClick=${copyCode} className="bg-white/10 hover:bg-white/15 px-4 py-2 rounded-lg text-sm font-medium transition-colors text-white/90 flex items-center gap-1.5">
                  <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                  Copiar Link
                </button>
                <button onClick=${shareWhatsApp} className="bg-emerald-500/20 hover:bg-emerald-500/30 border border-emerald-500/20 px-4 py-2 rounded-lg text-sm font-medium transition-colors text-emerald-300 flex items-center gap-1.5">
                  <svg className="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                  WhatsApp
                </button>
                <button onClick=${shareEmail} className="bg-white/10 hover:bg-white/15 px-4 py-2 rounded-lg text-sm font-medium transition-colors text-white/90 flex items-center gap-1.5">
                  <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                  Email
                </button>
              </div>
            </div>
            ${code && html`<div className="mt-3">
              <p className="text-gray-400 text-sm">Usado ${code.useCount} ${code.useCount === 1 ? 'vez' : 'veces'}</p>
              <p className="text-gray-600 text-xs mt-1">Comparte ahora y gana $50.000 por cada restaurante que se una</p>
            </div>`}
          </div>
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <${SpotlightCard} style=${{ '--spotlight-color': 'rgba(16,185,129,0.12)' }}>
            <p className="text-sm text-gray-400">Total Ganado</p>
            <p className="text-3xl font-bold text-emerald-400 mt-1"><${AnimatedCounter} value=${totalEarned} format=${function(v) { return formatCLP(v); }} /></p>
          </${SpotlightCard}>
          <${SpotlightCard} style=${{ '--spotlight-color': 'rgba(124,58,237,0.12)' }}>
            <p className="text-sm text-gray-400">Referidos Enviados</p>
            <p className="text-3xl font-bold text-white mt-1"><${AnimatedCounter} value=${sent.length} /></p>
          </${SpotlightCard}>
          <${SpotlightCard} style=${{ '--spotlight-color': 'rgba(59,130,246,0.12)' }}>
            <p className="text-sm text-gray-400">Recompensas Activas</p>
            <p className="text-3xl font-bold text-ocean-400 mt-1"><${AnimatedCounter} value=${activeRewards} /></p>
          </${SpotlightCard}>
          <${SpotlightCard} style=${{ '--spotlight-color': 'rgba(96,165,250,0.12)' }}>
            <p className="text-sm text-gray-400">Recompensas Canjeadas</p>
            <p className="text-3xl font-bold text-blue-400 mt-1"><${AnimatedCounter} value=${redeemedRewards} /></p>
          </${SpotlightCard}>
        </div>

        <${SpotlightCard}>
          <h3 className="text-lg font-semibold text-white mb-6">Tu Embudo de Referidos</h3>
          <div className="flex items-center justify-between gap-2 sm:gap-4">
            <div className="flex-1 text-center">
              <div className=${'mx-auto w-16 h-16 sm:w-20 sm:h-20 rounded-full flex items-center justify-center text-xl sm:text-2xl font-bold border-2 ' + (funnelSent > 0 ? 'bg-yellow-500/15 border-yellow-500/30 text-yellow-300' : 'bg-white/5 border-white/10 text-gray-500')}>${funnelSent}</div>
              <p className="text-xs sm:text-sm text-gray-400 mt-2 font-medium">Enviados</p>
            </div>
            <div className="flex-shrink-0">
              <div className=${'h-1 w-8 sm:w-12 rounded ' + (funnelQualified > 0 ? 'bg-gradient-to-r from-yellow-500/50 to-blue-500/50' : 'bg-white/10')} />
            </div>
            <div className="flex-1 text-center">
              <div className=${'mx-auto w-16 h-16 sm:w-20 sm:h-20 rounded-full flex items-center justify-center text-xl sm:text-2xl font-bold border-2 ' + (funnelQualified > 0 ? 'bg-blue-500/15 border-blue-500/30 text-blue-300' : 'bg-white/5 border-white/10 text-gray-500')}>${funnelQualified}</div>
              <p className="text-xs sm:text-sm text-gray-400 mt-2 font-medium">Calificados</p>
            </div>
            <div className="flex-shrink-0">
              <div className=${'h-1 w-8 sm:w-12 rounded ' + (funnelRewarded > 0 ? 'bg-gradient-to-r from-blue-500/50 to-emerald-500/50' : 'bg-white/10')} />
            </div>
            <div className="flex-1 text-center">
              <div className=${'mx-auto w-16 h-16 sm:w-20 sm:h-20 rounded-full flex items-center justify-center text-xl sm:text-2xl font-bold border-2 ' + (funnelRewarded > 0 ? 'bg-emerald-500/15 border-emerald-500/30 text-emerald-300' : 'bg-white/5 border-white/10 text-gray-500')}>${funnelRewarded}</div>
              <p className="text-xs sm:text-sm text-gray-400 mt-2 font-medium">Recompensados</p>
            </div>
          </div>
          ${funnelSent > 0 && html`<div className="flex justify-center gap-4 mt-4 text-xs text-gray-500">
            <span>${funnelSent > 0 ? Math.round((funnelQualified / funnelSent) * 100) : 0}% calificacion</span>
            <span>${funnelQualified > 0 ? Math.round((funnelRewarded / funnelQualified) * 100) : 0}% recompensa</span>
          </div>`}
        </${SpotlightCard}>

        <${SpotlightCard} style=${{ '--spotlight-color': 'rgba(124,58,237,0.08)' }}>
          <div className="flex items-center gap-3 mb-3">
            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-justo-500 to-ocean-500 flex items-center justify-center text-white">
              <svg className="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            </div>
            <div className="flex-1">
              <p className="text-sm font-bold text-white">${milestoneLevel}</p>
              <p className="text-xs text-gray-400">${milestoneLabel}</p>
            </div>
            ${rank && rank.position && html`<div className="text-right">
              <p className=${'text-lg font-bold ' + (rank.position === 1 ? 'text-yellow-400' : 'text-justo-400')}>#${rank.position}</p>
              <p className="text-xs text-gray-500">de ${rank.total} referidores</p>
            </div>`}
          </div>
          ${milestoneNext > 0 && html`<div className="mt-2">
            <div className="flex justify-between text-xs text-gray-500 mb-1">
              <span>${qualifiedCount} referidos exitosos</span>
              <span>${milestoneNext}</span>
            </div>
            <div className="h-2.5 rounded-full overflow-hidden" style=${{ background: 'rgba(255,255,255,0.06)' }}>
              <div className="h-full bg-gradient-to-r from-justo-500 to-ocean-400 rounded-full transition-all duration-500" style=${{ width: milestoneProgress + '%' }} />
            </div>
          </div>`}
          ${rank && rank.position === 1 && html`<div className="mt-3 flex items-center gap-1.5 text-yellow-400">
            <svg className="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
            <span className="text-xs font-bold">Eres el referidor #1!</span>
          </div>`}
        </${SpotlightCard}>

        <${SpotlightCard}>
          <h3 className="text-lg font-semibold text-white mb-4">Tus Logros</h3>
          <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">
            ${[
              { name: 'Primer Referido', earned: qualifiedCount >= 1, icon: 'M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z', bg: 'bg-yellow-500/10', color: 'text-yellow-400', border: 'border-yellow-500/20', glow: 'rgba(234,179,8,0.3)' },
              { name: 'Trio de Ases', earned: qualifiedCount >= 3, icon: 'M13 7h8m0 0v8m0-8l-8 8-4-4-6 6', bg: 'bg-blue-500/10', color: 'text-blue-400', border: 'border-blue-500/20', glow: 'rgba(59,130,246,0.3)', stroke: true },
              { name: 'Top 5', earned: qualifiedCount >= 5, icon: 'M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z', bg: 'bg-purple-500/10', color: 'text-purple-400', border: 'border-purple-500/20', glow: 'rgba(168,85,247,0.3)', stroke: true },
              { name: 'Embajador', earned: qualifiedCount >= 10, icon: 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z', bg: 'bg-amber-500/10', color: 'text-amber-400', border: 'border-amber-500/20', glow: 'rgba(245,158,11,0.3)', stroke: true },
              { name: 'Primer Canje', earned: redeemedRewards >= 1, icon: 'M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7', bg: 'bg-emerald-500/10', color: 'text-emerald-400', border: 'border-emerald-500/20', glow: 'rgba(16,185,129,0.3)', stroke: true },
            ].map(function(badge) {
              return html`<div key=${badge.name} className=${'rounded-xl p-3 text-center border transition-all ' + (badge.earned ? badge.bg + ' ' + badge.border + ' badge-earned' : 'bg-white/[0.02] border-white/[0.06] opacity-40 grayscale')} style=${badge.earned ? { '--badge-glow': badge.glow } : {}}>
                <div className=${'mx-auto mb-2 flex justify-center ' + (badge.earned ? badge.color : 'text-gray-600')}>
                  <svg className="h-7 w-7" fill=${badge.stroke ? 'none' : 'currentColor'} stroke=${badge.stroke ? 'currentColor' : 'none'} viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d=${badge.icon} />
                  </svg>
                </div>
                <p className=${'text-xs font-semibold ' + (badge.earned ? 'text-white' : 'text-gray-600')}>${badge.name}</p>
                ${badge.earned && html`<p className=${'text-xs mt-0.5 ' + badge.color}>Desbloqueado</p>`}
              </div>`;
            })}
          </div>
        </${SpotlightCard}>

        <${SpotlightCard}>
          <h3 className="text-lg font-semibold text-white mb-4">Actividad Reciente</h3>
          ${sent.length === 0
            ? html`<p className="text-gray-500 text-sm">Aun no has referido a nadie. Comparte tu codigo!</p>`
            : html`<div className="space-y-1">
                ${sent.slice(0, 5).map(function(r) {
                  return html`<div key=${r.id} className="flex items-center justify-between py-2.5 px-2 rounded-lg border-b border-white/[0.04] last:border-0 hover:bg-white/[0.03] transition-colors">
                    <div>
                      <p className="text-sm font-medium text-white">${r.referredRestaurant.name}</p>
                      <p className="text-xs text-gray-500">${new Date(r.createdAt).toLocaleDateString('es-CL')}</p>
                    </div>
                    <${StatusBadge} status=${r.status} />
                  </div>`;
                })}
                ${sent.length > 5 && html`<a href="#/referidos" className="block text-center text-sm text-justo-400 hover:text-justo-300 font-medium pt-2">Ver todos (${sent.length})</a>`}
              </div>`}
        </${SpotlightCard}>
      </div>`;
    }

    // ─── Referrals ───────────────────────────────────────
    function Referrals() {
      var toast = useToast();
      var _t = useState('sent'), tab = _t[0], setTab = _t[1];
      var _s = useState([]), sent = _s[0], setSent = _s[1];
      var _r = useState(null), received = _r[0], setReceived = _r[1];
      var _l = useState(true), loading = _l[0], setLoading = _l[1];

      useEffect(function() {
        Promise.all([api('/referrals/sent'), api('/referrals/received')])
          .then(function(res) { setSent(res[0]); setReceived(res[1]); })
          .catch(function(err) { toast.addToast('Error al cargar referidos', 'error'); })
          .finally(function() { setLoading(false); });
      }, []);

      if (loading) return html`<div className="space-y-6">
        <div className="h-8 w-48 rounded shimmer" />
        <${SkeletonCard} rows=${4} />
      </div>`;

      return html`<div className="space-y-6">
        <h2 className="text-2xl font-bold text-gradient">Referidos</h2>
        <div className="flex rounded-lg p-1 w-fit" role="tablist" style=${{ background: 'rgba(255,255,255,0.06)' }}>
          <button onClick=${function() { setTab('sent'); }} role="tab" aria-selected=${tab === 'sent'} className=${'px-4 py-2 text-sm font-medium rounded-md transition-colors ' + (tab === 'sent' ? 'bg-white/10 text-white' : 'text-gray-500')}>Mis Referidos (${sent.length})</button>
          <button onClick=${function() { setTab('received'); }} role="tab" aria-selected=${tab === 'received'} className=${'px-4 py-2 text-sm font-medium rounded-md transition-colors ' + (tab === 'received' ? 'bg-white/10 text-white' : 'text-gray-500')}>Mi Referido</button>
        </div>

        ${tab === 'sent' && html`<${SpotlightCard}>
          ${sent.length === 0
            ? html`<${EmptyState} title="Sin referidos" description="Comparte tu codigo para empezar a referir restaurantes." />`
            : html`<div className="overflow-x-auto"><table className="w-full">
                <thead><tr className="border-b border-white/[0.06]">
                  <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Restaurante</th>
                  <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Estado</th>
                  <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Fecha</th>
                </tr></thead>
                <tbody>${sent.map(function(r) {
                  return html`<tr key=${r.id} className="border-b border-white/[0.04] last:border-0 hover:bg-white/[0.02] transition-colors">
                    <td className="px-6 py-4 text-sm font-medium text-white">${r.referredRestaurant.name}</td>
                    <td className="px-6 py-4"><${StatusBadge} status=${r.status} /></td>
                    <td className="px-6 py-4 text-sm text-gray-400">${new Date(r.createdAt).toLocaleDateString('es-CL')}</td>
                  </tr>`;
                })}</tbody>
              </table></div>`}
        </${SpotlightCard}>`}

        ${tab === 'received' && html`<${SpotlightCard}>
          ${received
            ? html`<div className="space-y-3">
                <p className="text-sm text-gray-400">Fuiste referido por</p>
                <p className="text-xl font-semibold text-white">${received.referralCode && received.referralCode.referrer && received.referralCode.referrer.name}</p>
                <p className="text-sm text-gray-400">Codigo usado: <span className="font-mono text-justo-400">${received.referralCode && received.referralCode.code}</span></p>
                <div className="pt-2"><${StatusBadge} status=${received.status} /></div>
              </div>`
            : html`<${EmptyState} title="No fuiste referido" description="Puedes registrar tu restaurante con un codigo de referido." />`}
        </${SpotlightCard}>`}
      </div>`;
    }

    // ─── Register Restaurant ─────────────────────────────
    function RegisterRestaurant() {
      var toast = useToast();
      var _n = useState(''), name = _n[0], setName = _n[1];
      var _rc = useState(''), refCode = _rc[0], setRefCode = _rc[1];
      var _cs = useState(null), codeStatus = _cs[0], setCodeStatus = _cs[1];
      var _rn = useState(''), referrerName = _rn[0], setReferrerName = _rn[1];
      var _ce = useState(''), codeError = _ce[0], setCodeError = _ce[1];
      var _ld = useState(false), loading = _ld[0], setLoading = _ld[1];
      var _e = useState(''), error = _e[0], setError = _e[1];

      useEffect(function() {
        if (!refCode || refCode.length < 4) { setCodeStatus(null); return; }
        setCodeStatus('validating');
        var timer = setTimeout(function() {
          api('/referrals/validate/' + encodeURIComponent(refCode))
            .then(function(data) { setCodeStatus('valid'); setReferrerName(data.referrerName); setCodeError(''); })
            .catch(function(err) { setCodeStatus('invalid'); setCodeError(err.message); });
        }, 500);
        return function() { clearTimeout(timer); };
      }, [refCode]);

      function handleSubmit(e) {
        e.preventDefault();
        setError(''); setLoading(true);
        var body = { name: name };
        if (refCode) body.referralCode = refCode;
        api('/restaurants/register', { method: 'POST', body: JSON.stringify(body) })
          .then(function() { toast.addToast('Restaurante registrado exitosamente!'); navigate('/'); })
          .catch(function(err) { setError(err.message); })
          .finally(function() { setLoading(false); });
      }

      return html`<div className="max-w-lg mx-auto space-y-6">
        <h2 className="text-2xl font-bold text-gradient">Registrar Restaurante</h2>
        <${SpotlightCard}>
          <form onSubmit=${handleSubmit} className="space-y-5">
            <div>
              <label className="block text-sm font-medium text-gray-300 mb-1">Nombre del Restaurante</label>
              <input type="text" required value=${name} onInput=${function(e) { setName(e.target.value); }} className="input-dark" placeholder="Ej: Tacos El Rey" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-300 mb-1">Codigo de Referido <span className="text-gray-500">(opcional)</span></label>
              <div className="relative">
                <input type="text" value=${refCode} onInput=${function(e) { setRefCode(e.target.value.toUpperCase()); }} className="input-dark font-mono" placeholder="JUSTO-XXXXXXXX" />
                ${codeStatus === 'validating' && html`<div className="absolute right-3 top-2.5"><${Spinner} className="h-5 w-5 text-gray-500" /></div>`}
                ${codeStatus === 'valid' && html`<div className="absolute right-3 top-2.5 text-emerald-400"><svg className="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/></svg></div>`}
                ${codeStatus === 'invalid' && html`<div className="absolute right-3 top-2.5 text-red-400"><svg className="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg></div>`}
              </div>
              ${codeStatus === 'valid' && html`<p className="text-emerald-400 text-sm mt-1">Referido por ${referrerName}</p>`}
              ${codeStatus === 'invalid' && html`<p className="text-red-400 text-sm mt-1">${codeError}</p>`}
            </div>
            ${error && html`<p className="text-red-400 text-sm">${error}</p>`}
            <button type="submit" disabled=${loading} className="w-full btn-primary py-2.5">
              ${loading ? html`<${Spinner} className="h-5 w-5" />` : 'Registrar Restaurante'}
            </button>
          </form>
        </${SpotlightCard}>
      </div>`;
    }

    // ─── Rewards ─────────────────────────────────────────
    function Rewards() {
      var toast = useToast();
      var _r = useState([]), rewards = _r[0], setRewards = _r[1];
      var _l = useState(true), loading = _l[0], setLoading = _l[1];
      var _ri = useState(null), redeemingId = _ri[0], setRedeemingId = _ri[1];

      useEffect(function() {
        api('/rewards').then(setRewards).catch(function() {}).finally(function() { setLoading(false); });
      }, []);

      function redeem(id) {
        setRedeemingId(id);
        api('/rewards/' + id + '/redeem', { method: 'POST' })
          .then(function(updated) {
            setRewards(function(prev) { return prev.map(function(r) { return r.id === id ? Object.assign({}, r, updated) : r; }); });
            toast.addToast('Recompensa canjeada!');
          })
          .catch(function(err) { toast.addToast(err.message, 'error'); })
          .finally(function() { setRedeemingId(null); });
      }

      if (loading) return html`<div className="space-y-6">
        <div className="h-8 w-48 rounded shimmer" />
        <${SkeletonCard} rows=${3} />
        <${SkeletonCard} rows=${3} />
      </div>`;

      function rewardTitle(r) {
        if (r.beneficiaryType === 'REFERRER') return r.rewardType === 'CREDITS' ? 'Creditos por Referido' : 'Recompensa por Referido';
        return r.rewardType === 'DISCOUNT' ? 'Descuento Segundo Mes' : r.rewardType === 'FEE_WAIVER' ? 'Dias sin Comision' : 'Recompensa de Bienvenida';
      }

      return html`<div className="space-y-6">
        <h2 className="text-2xl font-bold text-gradient">Mis Recompensas</h2>
        ${rewards.length === 0
          ? html`<${SpotlightCard}><${EmptyState} title="Sin recompensas" description="Refiere restaurantes para ganar recompensas." /></${SpotlightCard}>`
          : html`<div className="grid gap-4">
              ${rewards.map(function(r) {
                return html`<${SpotlightCard} key=${r.id}>
                  <div className="flex items-start justify-between gap-2 mb-2">
                    <h3 className="font-semibold text-white">${rewardTitle(r)}</h3>
                    <${StatusBadge} status=${r.status} />
                  </div>
                  ${r.amount && html`<p className="text-2xl font-bold text-justo-400">${formatCLP(r.amount)}</p>`}
                  ${r.description && html`<p className="text-sm text-gray-400 mt-1">${r.description}</p>`}
                  <div className="flex items-center justify-between mt-3">
                    <p className="text-xs text-gray-500">${r.expiresAt ? 'Vence: ' + new Date(r.expiresAt).toLocaleDateString('es-CL') : ''}</p>
                    ${r.status === 'ISSUED' && html`<button onClick=${function() { redeem(r.id); }} disabled=${redeemingId === r.id}
                      className="btn-primary text-sm px-4 py-1.5">
                      ${redeemingId === r.id ? html`<${Spinner} className="h-4 w-4" />` : 'Canjear'}
                    </button>`}
                  </div>
                </${SpotlightCard}>`;
              })}
            </div>`}
      </div>`;
    }

    // ─── Admin Panel ─────────────────────────────────────
    function RankBadge(props) {
      var pos = props.position;
      if (pos === 1) return html`<div className="w-8 h-8 rounded-full bg-yellow-500/20 border border-yellow-500/30 flex items-center justify-center text-yellow-300 text-sm font-bold">1</div>`;
      if (pos === 2) return html`<div className="w-8 h-8 rounded-full bg-gray-500/20 border border-gray-500/30 flex items-center justify-center text-gray-300 text-sm font-bold">2</div>`;
      if (pos === 3) return html`<div className="w-8 h-8 rounded-full bg-amber-600/20 border border-amber-600/30 flex items-center justify-center text-amber-300 text-sm font-bold">3</div>`;
      return html`<div className="w-8 h-8 rounded-full bg-white/5 border border-white/10 flex items-center justify-center text-gray-400 text-sm font-medium">${pos}</div>`;
    }

    // ─── Viral Network Tree ─────────────────────────────
    function NetworkTree(props) {
      var edges = props.edges || [];
      if (edges.length === 0) return null;

      // Build adjacency: referrerId → children
      var childrenMap = {};
      var allReferredIds = {};
      edges.forEach(function(e) {
        if (!childrenMap[e.referrerId]) childrenMap[e.referrerId] = [];
        childrenMap[e.referrerId].push(e);
        allReferredIds[e.referredId] = true;
      });

      // Find root nodes (referrers who are not referred by anyone in this dataset)
      var rootIds = {};
      edges.forEach(function(e) {
        if (!allReferredIds[e.referrerId]) rootIds[e.referrerId] = e.referrerName;
      });

      var statusColor = { PENDING: 'bg-yellow-500/60', QUALIFIED: 'bg-blue-500/60', REWARDED: 'bg-emerald-500/60', EXPIRED: 'bg-gray-500/60' };
      var statusRing = { PENDING: 'ring-yellow-500/30', QUALIFIED: 'ring-blue-500/30', REWARDED: 'ring-emerald-500/30', EXPIRED: 'ring-gray-500/30' };

      // Compute max depth
      function getDepth(nodeId, visited) {
        if (visited[nodeId]) return 0;
        visited[nodeId] = true;
        var children = childrenMap[nodeId] || [];
        if (children.length === 0) return 0;
        var maxChild = 0;
        children.forEach(function(c) { var d = getDepth(c.referredId, visited); if (d > maxChild) maxChild = d; });
        return 1 + maxChild;
      }
      var maxDepth = 0;
      Object.keys(rootIds).forEach(function(rid) { var d = getDepth(rid, {}); if (d > maxDepth) maxDepth = d; });

      function renderNode(edge, depth) {
        var sc = statusColor[edge.status] || 'bg-gray-400';
        var sr = statusRing[edge.status] || 'ring-gray-200';
        var children = childrenMap[edge.referredId] || [];
        return html`<div key=${edge.referredId + edge.restaurantName} className="ml-6 sm:ml-10" style=${{ marginTop: '4px' }}>
          <div className="flex items-center gap-2.5 py-1.5">
            <div className="relative flex-shrink-0">
              <div className=${'w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold ring-2 ' + sc + ' ' + sr}>${edge.referredName.charAt(0)}</div>
            </div>
            <div className="min-w-0">
              <div className="flex items-center gap-2">
                <span className="text-sm font-medium text-white truncate">${edge.referredName}</span>
                <${StatusBadge} status=${edge.status} />
              </div>
              <p className="text-xs text-gray-500 truncate">${edge.restaurantName}</p>
            </div>
          </div>
          ${children.length > 0 && html`<div className="border-l-2 border-white/10 ml-4">
            ${children.map(function(c) { return renderNode(c, depth + 1); })}
          </div>`}
        </div>`;
      }

      return html`<div>
        ${Object.keys(rootIds).map(function(rid) {
          var rootChildren = childrenMap[rid] || [];
          return html`<div key=${rid} className="mb-4 last:mb-0">
            <div className="flex items-center gap-2.5 py-1.5">
              <div className="w-8 h-8 rounded-full bg-gradient-to-br from-justo-400 to-ocean-500 flex items-center justify-center text-white text-xs font-bold ring-2 ring-justo-500/30">${rootIds[rid].charAt(0)}</div>
              <span className="text-sm font-bold text-white">${rootIds[rid]}</span>
              <span className="text-xs text-gray-500">Referidor</span>
            </div>
            ${rootChildren.length > 0 && html`<div className="border-l-2 border-white/10 ml-4">
              ${rootChildren.map(function(c) { return renderNode(c, 1); })}
            </div>`}
          </div>`;
        })}
        <div className="flex items-center gap-4 mt-4 pt-4 border-t border-white/[0.06] text-xs text-gray-500">
          <span>Profundidad maxima: ${maxDepth + 1} niveles</span>
          <span>${edges.length} restaurantes conectados via boca a boca</span>
        </div>
      </div>`;
    }

    function AdminPanel() {
      var toast = useToast();
      var _r = useState([]), referrals = _r[0], setReferrals = _r[1];
      var _a = useState(null), analytics = _a[0], setAnalytics = _a[1];
      var _l = useState(true), loading = _l[0], setLoading = _l[1];
      var _f = useState('ALL'), filter = _f[0], setFilter = _f[1];
      var _q = useState(null), qualifyingId = _q[0], setQualifyingId = _q[1];
      var _search = useState(''), search = _search[0], setSearch = _search[1];
      var _page = useState(1), page = _page[0], setPage = _page[1];

      useEffect(function() {
        Promise.all([api('/referrals/admin/all'), api('/analytics/dashboard')])
          .then(function(res) { setReferrals(res[0]); setAnalytics(res[1]); })
          .catch(function(err) { toast.addToast('Error al cargar panel admin', 'error'); })
          .finally(function() { setLoading(false); });
      }, []);

      function qualify(id) {
        setQualifyingId(id);
        api('/referrals/' + id + '/qualify', { method: 'POST' })
          .then(function() {
            setReferrals(function(prev) { return prev.map(function(r) { return r.id === id ? Object.assign({}, r, { status: 'QUALIFIED' }) : r; }); });
            toast.addToast('Referido calificado!');
          })
          .catch(function(err) { toast.addToast(err.message, 'error'); })
          .finally(function() { setQualifyingId(null); });
      }

      if (loading) return html`<div className="space-y-6">
        <div className="h-8 w-64 rounded shimmer" />
        <${SkeletonGrid} cols=${3} />
        <${SkeletonCard} rows=${4} />
        <${SkeletonCard} rows=${5} />
      </div>`;

      var statusFiltered = filter === 'ALL' ? referrals : referrals.filter(function(r) { return r.status === filter; });
      var filtered = search ? statusFiltered.filter(function(r) {
        var ref = r.referralCode && r.referralCode.referrer;
        var rest = r.referredRestaurant;
        var q = search.toLowerCase();
        return (ref && ref.name && ref.name.toLowerCase().indexOf(q) !== -1)
          || (ref && ref.email && ref.email.toLowerCase().indexOf(q) !== -1)
          || (rest && rest.name && rest.name.toLowerCase().indexOf(q) !== -1);
      }) : statusFiltered;
      var perPage = 10;
      var paginatedReferrals = filtered.slice((page - 1) * perPage, page * perPage);
      var filters = ['ALL', 'PENDING', 'QUALIFIED', 'REWARDED', 'EXPIRED'];
      var filterLabels = { ALL: 'Todos', PENDING: 'Pendientes', QUALIFIED: 'Calificados', REWARDED: 'Recompensados', EXPIRED: 'Expirados' };

      // Reward type breakdown (client-side from referral data)
      var creditTotal = 0, discountTotal = 0;
      referrals.forEach(function(ref) {
        (ref.rewards || []).forEach(function(rw) {
          if (rw.rewardType === 'CREDITS' && rw.amount) creditTotal += rw.amount;
          if (rw.rewardType === 'DISCOUNT' && rw.amount) discountTotal += rw.amount;
        });
      });

      // Funnel widths
      var fTotal = analytics ? analytics.funnel.total : 0;
      var fQualPlus = analytics ? (analytics.funnel.qualified + analytics.funnel.rewarded) : 0;
      var fRewarded = analytics ? analytics.funnel.rewarded : 0;
      var widthQual = fTotal > 0 ? Math.round((fQualPlus / fTotal) * 100) : 0;
      var widthRew = fTotal > 0 ? Math.round((fRewarded / fTotal) * 100) : 0;
      var dropoff1 = fTotal > 0 ? Math.round(((fTotal - fQualPlus) / fTotal) * 100) : 0;
      var dropoff2 = fQualPlus > 0 ? Math.round(((fQualPlus - fRewarded) / fQualPlus) * 100) : 0;

      // Redeem progress
      var redeemPct = analytics && analytics.rewardEconomics.totalIssuedAmount > 0
        ? Math.round((analytics.rewardEconomics.totalRedeemedAmount / analytics.rewardEconomics.totalIssuedAmount) * 100) : 0;

      // Conversion rate color
      var convRate = analytics ? analytics.funnel.conversionRate : 0;
      var convColor = convRate >= 50 ? 'border-l-green-500' : convRate >= 25 ? 'border-l-yellow-500' : 'border-l-red-500';

      // Timeline chart data
      var timelineData = analytics ? analytics.timeline || [] : [];
      var timelineMax = 0;
      timelineData.forEach(function(t) { if (t.total > timelineMax) timelineMax = t.total; });
      var monthNames = { '01': 'Ene', '02': 'Feb', '03': 'Mar', '04': 'Abr', '05': 'May', '06': 'Jun', '07': 'Jul', '08': 'Ago', '09': 'Sep', '10': 'Oct', '11': 'Nov', '12': 'Dic' };

      return html`<div className="space-y-6">
        <div>
          <h2 className="text-2xl font-bold text-gradient">Panel de Administracion</h2>
          <p className="text-sm text-gray-500 mt-1">Metricas y gestion del programa de referidos</p>
        </div>

        ${analytics && html`<${React.Fragment}>
          <div className="bg-gradient-to-br from-gray-900 via-gray-800 to-justo-900 rounded-2xl shadow-xl p-6 text-white">
            <div className="flex items-center gap-2 mb-6">
              <svg className="h-5 w-5 text-justo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
              <h3 className="text-lg font-semibold">Inteligencia de Crecimiento</h3>
            </div>

            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              ${function() {
                var gm = analytics.growthMetrics;
                var k = gm.kFactor.allTime;
                var kColor = k >= 1 ? 'from-green-500/20 to-green-600/10 border-green-500/30' : k >= 0.5 ? 'from-yellow-500/20 to-yellow-600/10 border-yellow-500/30' : 'from-red-500/20 to-red-600/10 border-red-500/30';
                var kLabel = k >= 1 ? 'Crecimiento viral' : k >= 0.5 ? 'Pre-viral' : 'Sub-viral';
                var kTextColor = k >= 1 ? 'text-green-400' : k >= 0.5 ? 'text-yellow-400' : 'text-red-400';
                var vel = gm.velocity;
                var trendColor = vel.trend >= 0 ? 'text-green-400' : 'text-red-400';
                var trendArrow = vel.trend >= 0 ? 'M5 10l7-7m0 0l7 7m-7-7v18' : 'M19 14l-7 7m0 0l-7-7m7 7V3';
                return html`<${React.Fragment}>
                  <div className=${'bg-gradient-to-br border rounded-xl p-4 ' + kColor}>
                    <p className="text-xs text-gray-400 font-medium mb-1">Coeficiente Viral (K)</p>
                    <div className="flex items-baseline gap-2">
                      <span className="text-3xl font-bold text-white">${k}</span>
                      <span className=${'text-xs font-bold ' + kTextColor}>${kLabel}</span>
                    </div>
                    <div className="flex items-center gap-3 mt-2 text-xs text-gray-400">
                      <span>30d: ${gm.kFactor.last30d}</span>
                    </div>
                  </div>
                  <div className="bg-gradient-to-br from-ocean-500/20 to-ocean-600/10 border border-ocean-500/30 rounded-xl p-4">
                    <p className="text-xs text-gray-400 font-medium mb-1">Ciclo Viral</p>
                    <div className="flex items-baseline gap-1">
                      <span className="text-3xl font-bold text-white">${gm.viralCycleTimeDays !== null ? gm.viralCycleTimeDays : '--'}</span>
                      ${gm.viralCycleTimeDays !== null && html`<span className="text-sm text-gray-400">dias</span>`}
                    </div>
                    <p className="text-xs text-gray-400 mt-2">${gm.viralCycleTimeDays !== null ? 'Referido → refiere a otro' : 'Sin ciclos completados'}</p>
                  </div>
                  <div className="bg-gradient-to-br from-justo-500/20 to-justo-600/10 border border-justo-500/30 rounded-xl p-4">
                    <p className="text-xs text-gray-400 font-medium mb-1">Velocidad Semanal</p>
                    <div className="flex items-baseline gap-2">
                      <span className="text-3xl font-bold text-white">${vel.currentWeeklyAvg}</span>
                      <span className="text-sm text-gray-400">/sem</span>
                    </div>
                    <div className="flex items-center gap-1 mt-2">
                      <svg className=${'h-3 w-3 ' + trendColor} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d=${trendArrow}/></svg>
                      <span className=${'text-xs font-bold ' + trendColor}>${vel.trend > 0 ? '+' : ''}${vel.trend}%</span>
                      <span className="text-xs text-gray-500">vs previas</span>
                    </div>
                  </div>
                  <div className="bg-gradient-to-br from-green-500/20 to-green-600/10 border border-green-500/30 rounded-xl p-4">
                    <p className="text-xs text-gray-400 font-medium mb-1">ROI Estimado</p>
                    <div className="flex items-baseline gap-1">
                      <span className="text-3xl font-bold text-white">${gm.revenueImpact.programROI.toLocaleString('es-CL')}%</span>
                    </div>
                    <p className="text-xs text-gray-400 mt-2">Payback: ${gm.revenueImpact.paybackDays} dias</p>
                  </div>
                </${React.Fragment}>`;
              }()}
            </div>

            ${function() {
              var gm = analytics.growthMetrics;
              var proj = gm.projections;
              var cur = analytics.totals.restaurants;
              var maxProj = Math.max(proj.d90, cur, 1);
              return html`<div className="mb-6">
                <p className="text-xs text-gray-400 font-medium mb-3">Proyeccion de Crecimiento (basado en K=${gm.kFactor.allTime}, ciclo=${gm.viralCycleTimeDays || '?'}d)</p>
                <div className="relative">
                  <div className="h-8 bg-white/5 rounded-full overflow-hidden">
                    <div className="h-full bg-gradient-to-r from-justo-500 to-ocean-400 rounded-full transition-all duration-700" style=${{ width: Math.min(100, Math.round((cur / maxProj) * 100)) + '%' }} />
                  </div>
                  <div className="flex justify-between mt-2 text-xs">
                    <div className="text-center">
                      <p className="font-bold text-white">${cur}</p>
                      <p className="text-gray-500">Hoy</p>
                    </div>
                    ${proj.d30 > 0 && html`<div className="text-center">
                      <p className="font-bold text-justo-300">${proj.d30}</p>
                      <p className="text-gray-500">30d</p>
                    </div>`}
                    ${proj.d60 > 0 && html`<div className="text-center">
                      <p className="font-bold text-ocean-300">${proj.d60}</p>
                      <p className="text-gray-500">60d</p>
                    </div>`}
                    ${proj.d90 > 0 && html`<div className="text-center">
                      <p className="font-bold text-green-300">${proj.d90}</p>
                      <p className="text-gray-500">90d</p>
                    </div>`}
                  </div>
                </div>
              </div>`;
            }()}

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
              ${function() {
                var gm = analytics.growthMetrics;
                var nh = gm.networkHealth;
                var edges = analytics.networkEdges || [];
                var childrenMap = {};
                edges.forEach(function(e) {
                  if (!childrenMap[e.referrerId]) childrenMap[e.referrerId] = [];
                  childrenMap[e.referrerId].push(e);
                });
                var allReferredIds = {};
                edges.forEach(function(e) { allReferredIds[e.referredId] = true; });
                var rootIds = [];
                edges.forEach(function(e) { if (!allReferredIds[e.referrerId] && rootIds.indexOf(e.referrerId) === -1) rootIds.push(e.referrerId); });
                function getDepth(nid, vis) {
                  if (vis[nid]) return 0; vis[nid] = true;
                  var ch = childrenMap[nid] || [];
                  if (ch.length === 0) return 0;
                  var mx = 0; ch.forEach(function(c) { var d = getDepth(c.referredId, vis); if (d > mx) mx = d; });
                  return 1 + mx;
                }
                var maxD = 0;
                rootIds.forEach(function(r) { var d = getDepth(r, {}); if (d > maxD) maxD = d; });
                var totalChildren = 0; var activeNodes = 0;
                Object.keys(childrenMap).forEach(function(k) { totalChildren += childrenMap[k].length; activeNodes++; });
                var branchFactor = activeNodes > 0 ? Math.round((totalChildren / activeNodes) * 100) / 100 : 0;

                return html`<div className="bg-white/5 rounded-xl p-4 border border-white/10">
                  <p className="text-sm font-semibold text-white mb-3">Salud de Red</p>
                  <div className="space-y-3">
                    <div>
                      <div className="flex justify-between text-xs mb-1">
                        <span className="text-gray-400">Tasa de Activacion</span>
                        <span className="font-bold text-white">${nh.activationRate}%</span>
                      </div>
                      <div className="h-2 bg-white/10 rounded-full overflow-hidden">
                        <div className="h-full bg-justo-400 rounded-full" style=${{ width: Math.min(100, nh.activationRate) + '%' }} />
                      </div>
                    </div>
                    <div className="flex justify-between text-xs">
                      <span className="text-gray-400">Referidores Activos</span>
                      <span className="text-white">${nh.activeReferrers} de ${nh.usersWithCodes}</span>
                    </div>
                    <div className="flex justify-between text-xs">
                      <span className="text-gray-400">Profundidad Max.</span>
                      <span className="text-white">${maxD + 1} niveles</span>
                    </div>
                    <div className="flex justify-between text-xs">
                      <span className="text-gray-400">Factor de Ramificacion</span>
                      <span className="text-white">${branchFactor}x</span>
                    </div>
                  </div>
                </div>`;
              }()}
              ${function() {
                var ri = analytics.growthMetrics.revenueImpact;
                return html`<div className="bg-white/5 rounded-xl p-4 border border-white/10">
                  <p className="text-sm font-semibold text-white mb-3">Impacto en Ingresos *</p>
                  <div className="space-y-2">
                    <div className="flex justify-between text-xs">
                      <span className="text-gray-400">Ingreso Mensual Est.</span>
                      <span className="font-bold text-green-400">${formatCLP(ri.estimatedMonthlyRevenue)}</span>
                    </div>
                    <div className="flex justify-between text-xs">
                      <span className="text-gray-400">Ingreso Anual Est.</span>
                      <span className="font-bold text-green-300">${formatCLP(ri.estimatedAnnualRevenue)}</span>
                    </div>
                    <div className="flex justify-between text-xs">
                      <span className="text-gray-400">Restaurantes Calificados</span>
                      <span className="text-white">${ri.qualifiedRestaurants}</span>
                    </div>
                    <div className="pt-2 border-t border-white/10 text-xs text-gray-500">
                      * Supuestos: ${formatCLP(ri.assumptions.monthlyRevenuePerRestaurant)}/rest/mes, ${Math.round(ri.assumptions.commissionRate * 100)}% comision
                    </div>
                  </div>
                </div>`;
              }()}
            </div>

            ${function() {
              var vel = analytics.growthMetrics.velocity.weekly || [];
              if (vel.length === 0) return null;
              var maxW = 0;
              vel.forEach(function(w) { if (w.total > maxW) maxW = w.total; });
              return html`<div className="mt-4 pt-4 border-t border-white/10">
                <p className="text-xs text-gray-400 font-medium mb-2">Velocidad Semanal (ultimas 12 semanas)</p>
                <div className="flex items-end gap-1 h-12">
                  ${vel.map(function(w) {
                    var h = maxW > 0 ? Math.max(Math.round((w.total / maxW) * 48), 4) : 4;
                    var hq = maxW > 0 ? Math.round((w.qualified / maxW) * 48) : 0;
                    return html`<div key=${w.week} className="flex-1 relative" style=${{ height: '48px' }}>
                      <div className="absolute bottom-0 left-0 right-0 bg-white/10 rounded-t-sm" style=${{ height: h + 'px' }} />
                      ${hq > 0 && html`<div className="absolute bottom-0 left-0 right-0 bg-justo-400/60 rounded-t-sm" style=${{ height: hq + 'px' }} />`}
                    </div>`;
                  })}
                </div>
                <div className="flex justify-between text-xs text-gray-500 mt-1">
                  <span>${vel.length > 0 ? vel[0].week.slice(5) : ''}</span>
                  <span>${vel.length > 0 ? vel[vel.length - 1].week.slice(5) : ''}</span>
                </div>
              </div>`;
            }()}
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <${SpotlightCard} style=${{ '--spotlight-color': 'rgba(124,58,237,0.10)' }}>
              <p className="text-sm text-gray-400 font-medium">Total Referidos</p>
              <p className="text-3xl font-bold text-white mt-1"><${AnimatedCounter} value=${analytics.funnel.total} /></p>
              <p className="text-xs text-gray-500 mt-2">${analytics.funnel.pending} pendientes, ${analytics.funnel.qualified} calificados</p>
            </${SpotlightCard}>
            <${SpotlightCard} style=${{ '--spotlight-color': convRate >= 50 ? 'rgba(16,185,129,0.10)' : convRate >= 25 ? 'rgba(234,179,8,0.10)' : 'rgba(239,68,68,0.10)' }}>
              <p className="text-sm text-gray-400 font-medium">Tasa de Conversion</p>
              <p className="text-3xl font-bold text-white mt-1"><${AnimatedCounter} value=${analytics.funnel.conversionRate} />%</p>
              <p className="text-xs text-gray-500 mt-2">Calificados + Recompensados / Total</p>
            </${SpotlightCard}>
            <${SpotlightCard} style=${{ '--spotlight-color': 'rgba(59,130,246,0.10)' }}>
              <p className="text-sm text-gray-400 font-medium">Restaurantes Activos</p>
              <p className="text-3xl font-bold text-white mt-1"><${AnimatedCounter} value=${analytics.totals.restaurants} /></p>
              <p className="text-xs text-gray-500 mt-2">${analytics.totals.users} usuarios registrados</p>
            </${SpotlightCard}>
          </div>

          <${SpotlightCard}>
            <div className="flex items-center gap-2 mb-4">
              <svg className="h-5 w-5 text-justo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
              <h3 className="text-lg font-semibold text-white">Red de Referidos — Efecto Viral</h3>
            </div>
            <${NetworkTree} edges=${analytics.networkEdges} />
          </${SpotlightCard}>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <${SpotlightCard}>
              <h3 className="text-lg font-semibold text-white mb-6">Embudo de Conversion</h3>
              <div className="space-y-1">
                <div className="flex items-center gap-3">
                  <div className="w-24 text-right"><span className="text-xs font-medium text-gray-400">Total</span></div>
                  <div className="flex-1"><div className="relative h-10 rounded-lg overflow-hidden" style=${{ background: 'rgba(255,255,255,0.06)' }}>
                    <div className="h-full rounded-lg bg-yellow-500/40" style=${{ width: '100%' }} />
                    <div className="absolute inset-0 flex items-center justify-center"><span className="text-sm font-bold text-white">${analytics.funnel.pending + analytics.funnel.qualified + analytics.funnel.rewarded}</span></div>
                  </div></div>
                  <div className="w-12 text-right"><span className="text-xs text-gray-500">100%</span></div>
                </div>
                <div className="flex items-center gap-3 ml-24 pl-3">
                  <svg className="h-4 w-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
                  <span className="text-xs text-red-400">${dropoff1 > 0 ? '-' + dropoff1 + '% abandono' : 'Sin abandono'}</span>
                </div>
                <div className="flex items-center gap-3">
                  <div className="w-24 text-right"><span className="text-xs font-medium text-gray-400">Calificados</span></div>
                  <div className="flex-1"><div className="relative h-10 rounded-lg overflow-hidden" style=${{ background: 'rgba(255,255,255,0.06)' }}>
                    <div className="h-full rounded-lg bg-blue-500/40 transition-all duration-500" style=${{ width: widthQual + '%' }} />
                    <div className="absolute inset-0 flex items-center justify-center"><span className="text-sm font-bold text-white">${fQualPlus}</span></div>
                  </div></div>
                  <div className="w-12 text-right"><span className="text-xs text-gray-500">${widthQual}%</span></div>
                </div>
                <div className="flex items-center gap-3 ml-24 pl-3">
                  <svg className="h-4 w-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
                  <span className="text-xs text-red-400">${dropoff2 > 0 ? '-' + dropoff2 + '% pendiente' : 'Todos recompensados'}</span>
                </div>
                <div className="flex items-center gap-3">
                  <div className="w-24 text-right"><span className="text-xs font-medium text-gray-400">Recompensados</span></div>
                  <div className="flex-1"><div className="relative h-10 rounded-lg overflow-hidden" style=${{ background: 'rgba(255,255,255,0.06)' }}>
                    <div className="h-full rounded-lg bg-emerald-500/40 transition-all duration-500" style=${{ width: widthRew + '%' }} />
                    <div className="absolute inset-0 flex items-center justify-center"><span className="text-sm font-bold text-white">${fRewarded}</span></div>
                  </div></div>
                  <div className="w-12 text-right"><span className="text-xs text-gray-500">${widthRew}%</span></div>
                </div>
              </div>
              <div className="mt-4 pt-4 border-t border-white/[0.06] flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <div className="h-6 rounded bg-white/10 flex items-center justify-center px-3"><span className="text-xs font-medium text-gray-400">${analytics.funnel.expired}</span></div>
                  <span className="text-xs text-gray-500">Expirados</span>
                </div>
                <span className="text-xs text-gray-500">Tiempo promedio: ${analytics.avgTimeToQualifyDays} dias</span>
              </div>
            </${SpotlightCard}>

            <${SpotlightCard}>
              <h3 className="text-lg font-semibold text-white mb-4">Economia Unitaria</h3>
              <div className="grid grid-cols-3 gap-3 mb-6">
                <div className="bg-red-500/10 border border-red-500/20 rounded-lg p-3 text-center">
                  <p className="text-xs text-red-400 font-medium">Costo por Lead</p>
                  <p className="text-sm font-bold text-red-300">${formatCLP(analytics.unitEconomics.costPerQualified)}</p>
                </div>
                <div className="bg-justo-500/10 border border-justo-500/20 rounded-lg p-3 text-center">
                  <p className="text-xs text-justo-400 font-medium">Gasto Total</p>
                  <p className="text-sm font-bold text-justo-300">${formatCLP(analytics.unitEconomics.totalProgramSpend)}</p>
                </div>
                <div className="bg-ocean-500/10 border border-ocean-500/20 rounded-lg p-3 text-center">
                  <p className="text-xs text-ocean-400 font-medium">Prom. x Referido</p>
                  <p className="text-sm font-bold text-ocean-300">${formatCLP(analytics.unitEconomics.avgRewardPerReferral)}</p>
                </div>
              </div>
              <div className="space-y-4">
                <div>
                  <div className="flex justify-between text-sm mb-2">
                    <span className="text-gray-400">Total Emitido</span>
                    <span className="font-bold text-white">${formatCLP(analytics.rewardEconomics.totalIssuedAmount)}</span>
                  </div>
                  <div className="h-4 rounded-full overflow-hidden" style=${{ background: 'rgba(255,255,255,0.06)' }}>
                    <div className="h-full bg-gradient-to-r from-justo-500 to-ocean-500 rounded-full" style=${{ width: '100%' }} />
                  </div>
                </div>
                <div>
                  <div className="flex justify-between text-sm mb-2">
                    <span className="text-gray-400">Total Canjeado</span>
                    <span className="font-bold text-emerald-400">${formatCLP(analytics.rewardEconomics.totalRedeemedAmount)}</span>
                  </div>
                  <div className="h-4 rounded-full overflow-hidden" style=${{ background: 'rgba(255,255,255,0.06)' }}>
                    <div className="h-full bg-emerald-500/60 rounded-full transition-all duration-500" style=${{ width: redeemPct + '%' }} />
                  </div>
                  <div className="flex justify-between text-xs text-gray-500 mt-1">
                    <span>${redeemPct}% del total emitido</span>
                    <span>Ahorro potencial: ${formatCLP(analytics.rewardEconomics.totalIssuedAmount - analytics.rewardEconomics.totalRedeemedAmount)}</span>
                  </div>
                </div>
              </div>
              <div className="flex gap-3 mt-5">
                <div className="flex-1 bg-justo-500/10 border border-justo-500/20 rounded-lg p-3 text-center">
                  <p className="text-xs text-justo-400 font-medium">Creditos</p>
                  <p className="text-sm font-bold text-justo-300">${formatCLP(creditTotal)}</p>
                </div>
                <div className="flex-1 bg-ocean-500/10 border border-ocean-500/20 rounded-lg p-3 text-center">
                  <p className="text-xs text-ocean-400 font-medium">Descuentos</p>
                  <p className="text-sm font-bold text-ocean-300">${formatCLP(discountTotal)}</p>
                </div>
              </div>
            </${SpotlightCard}>
          </div>

          ${timelineData.length > 0 && html`<${SpotlightCard}>
            <h3 className="text-lg font-semibold text-white mb-6">Crecimiento del Programa</h3>
            <div className="flex items-end gap-3 sm:gap-6 justify-center" style=${{ height: '180px' }}>
              ${timelineData.map(function(t) {
                var hTotal = timelineMax > 0 ? Math.max(Math.round((t.total / timelineMax) * 160), 12) : 12;
                var hQual = timelineMax > 0 ? Math.round((t.qualified / timelineMax) * 160) : 0;
                var hRew = timelineMax > 0 ? Math.round((t.rewarded / timelineMax) * 160) : 0;
                var parts = t.month.split('-');
                var label = (monthNames[parts[1]] || parts[1]) + ' ' + parts[0].slice(2);
                return html`<div key=${t.month} className="flex flex-col items-center gap-1 flex-1 max-w-[80px]">
                  <span className="text-xs font-bold text-white">${t.total}</span>
                  <div className="w-full flex flex-col items-center gap-0.5">
                    <div className="relative w-full flex justify-center">
                      <div className="w-8 sm:w-12 rounded-t-md relative" style=${{ height: hTotal + 'px', background: 'rgba(255,255,255,0.08)' }}>
                        ${hQual > 0 && html`<div className="absolute bottom-0 left-0 right-0 bg-blue-500/50 rounded-t-sm" style=${{ height: hQual + 'px' }} />`}
                        ${hRew > 0 && html`<div className="absolute bottom-0 left-0 right-0 bg-emerald-500/50 rounded-t-sm" style=${{ height: hRew + 'px' }} />`}
                      </div>
                    </div>
                  </div>
                  <span className="text-xs text-gray-500 font-medium">${label}</span>
                </div>`;
              })}
            </div>
            <div className="flex items-center justify-center gap-6 mt-4 pt-3 border-t border-white/[0.06]">
              <div className="flex items-center gap-1.5"><div className="w-3 h-3 rounded-sm" style=${{ background: 'rgba(255,255,255,0.08)' }} /><span className="text-xs text-gray-500">Total</span></div>
              <div className="flex items-center gap-1.5"><div className="w-3 h-3 rounded-sm bg-blue-500/50" /><span className="text-xs text-gray-500">Calificados</span></div>
              <div className="flex items-center gap-1.5"><div className="w-3 h-3 rounded-sm bg-emerald-500/50" /><span className="text-xs text-gray-500">Recompensados</span></div>
            </div>
          </${SpotlightCard}>`}

          ${analytics.topReferrers.length > 0 && html`<${SpotlightCard}>
            <h3 className="text-lg font-semibold text-white mb-4">Top Referidores</h3>
            <div className="overflow-x-auto"><table className="w-full">
              <thead><tr className="border-b border-white/[0.06]">
                <th className="text-left px-3 py-2 text-xs font-medium text-gray-500 uppercase w-12">#</th>
                <th className="text-left px-3 py-2 text-xs font-medium text-gray-500 uppercase">Nombre</th>
                <th className="text-center px-3 py-2 text-xs font-medium text-gray-500 uppercase">Enviados</th>
                <th className="text-center px-3 py-2 text-xs font-medium text-gray-500 uppercase">Calificados</th>
                <th className="text-center px-3 py-2 text-xs font-medium text-gray-500 uppercase">Conversion</th>
                <th className="text-right px-3 py-2 text-xs font-medium text-gray-500 uppercase">Ganado</th>
              </tr></thead>
              <tbody>
                ${analytics.topReferrers.map(function(r, i) {
                  var convR = r.totalReferrals > 0 ? Math.round((r.qualifiedCount / r.totalReferrals) * 100) : 0;
                  return html`<tr key=${r.id} className="border-b border-white/[0.04] last:border-0 hover:bg-white/[0.02] transition-colors">
                    <td className="px-3 py-3"><${RankBadge} position=${i + 1} /></td>
                    <td className="px-3 py-3">
                      <p className="text-sm font-medium text-white">${r.name}</p>
                      <p className="text-xs text-gray-500">${r.email}</p>
                    </td>
                    <td className="px-3 py-3 text-center text-sm font-medium text-gray-300">${r.totalReferrals}</td>
                    <td className="px-3 py-3 text-center text-sm font-bold text-emerald-400">${r.qualifiedCount}</td>
                    <td className="px-3 py-3 text-center text-sm text-gray-400">${convR}%</td>
                    <td className="px-3 py-3 text-right text-sm font-bold text-justo-400">${formatCLP(r.totalEarned)}</td>
                  </tr>`;
                })}
              </tbody>
            </table></div>
          </${SpotlightCard}>`}

          ${analytics.codePerformance && analytics.codePerformance.length > 0 && html`<${SpotlightCard}>
            <h3 className="text-lg font-semibold text-white mb-4">Rendimiento por Codigo</h3>
            <div className="overflow-x-auto"><table className="w-full">
              <thead><tr className="border-b border-white/[0.06]">
                <th className="text-left px-3 py-2 text-xs font-medium text-gray-500 uppercase">Codigo</th>
                <th className="text-left px-3 py-2 text-xs font-medium text-gray-500 uppercase">Referidor</th>
                <th className="text-center px-3 py-2 text-xs font-medium text-gray-500 uppercase">Enviados</th>
                <th className="text-center px-3 py-2 text-xs font-medium text-gray-500 uppercase">Calificados</th>
                <th className="text-left px-3 py-2 text-xs font-medium text-gray-500 uppercase w-40">Conversion</th>
              </tr></thead>
              <tbody>
                ${analytics.codePerformance.map(function(cp) {
                  var barColor = cp.conversionRate > 50 ? 'bg-emerald-500/60' : cp.conversionRate >= 25 ? 'bg-yellow-500/60' : 'bg-red-500/60';
                  return html`<tr key=${cp.code} className="border-b border-white/[0.04] last:border-0 hover:bg-white/[0.02] transition-colors">
                    <td className="px-3 py-3 font-mono text-sm text-justo-400 font-medium">${cp.code}</td>
                    <td className="px-3 py-3 text-sm text-gray-300">${cp.referrerName}</td>
                    <td className="px-3 py-3 text-center text-sm font-medium text-gray-300">${cp.totalReferrals}</td>
                    <td className="px-3 py-3 text-center text-sm font-bold text-emerald-400">${cp.qualifiedCount}</td>
                    <td className="px-3 py-3">
                      <div className="flex items-center gap-2">
                        <div className="flex-1 h-2.5 rounded-full overflow-hidden" style=${{ background: 'rgba(255,255,255,0.06)' }}>
                          <div className=${'h-full rounded-full ' + barColor} style=${{ width: cp.conversionRate + '%' }} />
                        </div>
                        <span className="text-xs font-medium text-gray-400 w-8 text-right">${cp.conversionRate}%</span>
                      </div>
                    </td>
                  </tr>`;
                })}
              </tbody>
            </table></div>
          </${SpotlightCard}>`}
        </${React.Fragment}>`}

        <div>
          <h3 className="text-lg font-semibold text-white mb-4">Gestion de Referidos</h3>
          <div className="flex items-center gap-3 flex-wrap mb-4">
            ${filters.map(function(f) {
              return html`<button key=${f} onClick=${function() { setFilter(f); setPage(1); }}
                className=${'px-3 py-1.5 text-sm font-medium rounded-lg transition-colors ' + (filter === f ? 'bg-justo-500 text-white' : 'bg-white/5 border border-white/10 text-gray-400 hover:bg-white/10')}>
                ${filterLabels[f]}${f !== 'ALL' ? ' (' + referrals.filter(function(r) { return r.status === f; }).length + ')' : ''}
              </button>`;
            })}
          </div>
          <div className="mb-4">
            <${SearchInput} value=${search} onInput=${function(e) { setSearch(e.target.value); setPage(1); }} placeholder="Buscar por nombre, email o restaurante..." />
          </div>
          <${SpotlightCard}>
            ${filtered.length === 0
              ? html`<${EmptyState} title="Sin referidos" description="No hay referidos con este filtro." />`
              : html`<div className="overflow-x-auto"><table className="w-full">
                  <thead><tr className="border-b border-white/[0.06]">
                    <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Referente</th>
                    <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Restaurante</th>
                    <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Estado</th>
                    <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Fecha</th>
                    <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Acciones</th>
                  </tr></thead>
                  <tbody>${paginatedReferrals.map(function(r) {
                    var ref = r.referralCode && r.referralCode.referrer;
                    var rest = r.referredRestaurant;
                    return html`<tr key=${r.id} className="border-b border-white/[0.04] last:border-0 hover:bg-white/[0.02] transition-colors">
                      <td className="px-6 py-4">
                        <p className="text-sm font-medium text-white">${ref && ref.name}</p>
                        <p className="text-xs text-gray-500">${ref && ref.email}</p>
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-300">${rest && rest.name}</td>
                      <td className="px-6 py-4"><${StatusBadge} status=${r.status} /></td>
                      <td className="px-6 py-4 text-sm text-gray-400">${new Date(r.createdAt).toLocaleDateString('es-CL')}</td>
                      <td className="px-6 py-4">
                        ${r.status === 'PENDING' && html`<button onClick=${function() { qualify(r.id); }} disabled=${qualifyingId === r.id}
                          className="btn-primary text-xs px-3 py-1.5">
                          ${qualifyingId === r.id ? html`<${Spinner} className="h-3 w-3" />` : 'Calificar'}
                        </button>`}
                      </td>
                    </tr>`;
                  })}</tbody>
                </table></div>
                <${Pagination} page=${page} total=${filtered.length} perPage=${perPage} onPageChange=${setPage} />`}
          </${SpotlightCard}>
        </div>
      </div>`;
    }

    // ─── Invite Page (Restaurant Onboarding) ──────────────
    function InvitePage(props) {
      var auth = useAuth();
      var toast = useToast();
      var code = props.code;
      var _rs = useState('loading'), refStatus = _rs[0], setRefStatus = _rs[1];
      var _rn = useState(''), referrerName = _rn[0], setReferrerName = _rn[1];
      var _bd = useState(null), benefitData = _bd[0], setBenefitData = _bd[1];
      var _tr = useState(0), totalReferrals = _tr[0], setTotalReferrals = _tr[1];
      var _step = useState(0), step = _step[0], setStep = _step[1];
      var _f = useState({ restaurantName: '', name: '', email: '', password: '' }), form = _f[0], setForm = _f[1];
      var _ld = useState(false), loading = _ld[0], setLoading = _ld[1];
      var _e = useState(''), error = _e[0], setError = _e[1];

      useEffect(function() {
        if (!code) { setRefStatus('invalid'); return; }
        api('/referrals/validate/' + encodeURIComponent(code))
          .then(function(data) {
            setRefStatus('valid');
            setReferrerName(data.referrerName);
            setBenefitData(data.referredBenefit);
            setTotalReferrals(data.totalReferrals || 0);
          })
          .catch(function() { setRefStatus('invalid'); });
      }, [code]);

      function handleSubmit(e) {
        e.preventDefault();
        setError(''); setLoading(true);
        api('/auth/register-with-referral', {
          method: 'POST',
          body: JSON.stringify({
            name: form.name,
            email: form.email,
            password: form.password,
            restaurantName: form.restaurantName,
            referralCode: code
          })
        })
          .then(function(data) {
            auth.login(data.user, data.token);
            toast.addToast('Tu restaurante ha sido registrado en Justo!');
            navigate('/');
          })
          .catch(function(err) { setError(err.message); })
          .finally(function() { setLoading(false); });
      }

      if (refStatus === 'loading') return html`<${LoadingScreen} />`;

      if (refStatus === 'invalid') return html`<div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
        <${BackgroundBeams} />
        <${FloatingOrbs} />
        <div className="w-full max-w-md text-center relative z-10">
          <div className="glass rounded-2xl p-8">
            <div className="text-red-400 mb-4"><svg className="mx-auto h-16 w-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg></div>
            <h2 className="text-xl font-bold text-white mb-2">Codigo de invitacion invalido</h2>
            <p className="text-gray-400 mb-6">Este link de invitacion no es valido o ha expirado.</p>
            <a href="#/login" className="inline-block btn-primary py-2.5 px-6">Ir a Iniciar Sesion</a>
          </div>
        </div>
      </div>`;

      var benefitHeadline = benefitData ? benefitData.headline : 'Beneficios exclusivos';
      var referrerInitial = referrerName ? referrerName.charAt(0).toUpperCase() : '?';

      // Step indicators
      var stepLabels = ['Tu beneficio', 'Tu restaurante', 'Tu cuenta'];

      var stepBar = html`<div className="flex items-center justify-center gap-2 mb-8">
        ${stepLabels.map(function(label, i) {
          var active = i === step;
          var done = i < step;
          return html`<div key=${i} className="flex items-center">
            ${i > 0 && html`<div className=${'w-8 h-0.5 mx-1 ' + (done ? 'bg-justo-500' : 'bg-white/10')} />`}
            <div className="flex flex-col items-center">
              <div className=${'w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold transition-colors ' + (active ? 'bg-justo-500 text-white' : done ? 'bg-justo-500 text-white' : 'bg-white/10 text-gray-500')}>
                ${done ? html`<svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M5 13l4 4L19 7"/></svg>` : (i + 1)}
              </div>
              <span className=${'text-xs mt-1 ' + (active ? 'text-justo-400 font-medium' : 'text-gray-500')}>${label}</span>
            </div>
          </div>`;
        })}
      </div>`;

      // Step 0: Welcome — Hero benefit + who invites + social proof
      if (step === 0) return html`<div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
        <${BackgroundBeams} />
        <${FloatingOrbs} />
        <div className="w-full max-w-lg relative z-10">
          <div className="text-center mb-6">
            <h1 className="text-4xl font-bold text-gradient">Justo</h1>
          </div>
          <div className="glass rounded-2xl overflow-hidden">
            <div className="p-8 pb-0">
              ${stepBar}

              <div className="flex items-center gap-3 mb-6">
                <div className="w-12 h-12 rounded-full bg-gradient-to-br from-justo-400 to-ocean-500 flex items-center justify-center text-white text-lg font-bold flex-shrink-0">${referrerInitial}</div>
                <div>
                  <p className="text-sm text-white font-medium">${referrerName} te invita</p>
                  <p className="text-xs text-gray-400">a registrar tu restaurante en Justo</p>
                </div>
              </div>
            </div>

            <div className="mx-6 rounded-xl bg-gradient-to-r from-justo-500 to-ocean-500 p-6 text-center text-white shadow-lg relative overflow-hidden">
              <div className="absolute top-0 right-0 w-24 h-24 bg-white/10 rounded-full -translate-y-8 translate-x-8"></div>
              <div className="absolute bottom-0 left-0 w-16 h-16 bg-white/10 rounded-full translate-y-6 -translate-x-6"></div>
              <p className="text-white/80 text-sm font-medium mb-1 relative">Tu beneficio por registrarte</p>
              <p className="text-3xl sm:text-4xl font-bold relative">${benefitHeadline}</p>
              <div className="inline-block mt-3 bg-white/20 backdrop-blur-sm rounded-full px-3 py-1 text-xs font-medium relative">Al unirte con esta invitacion</div>
            </div>

            <div className="p-8 pt-6 space-y-6">
              <div className="grid grid-cols-2 gap-3">
                <div className="rounded-xl p-4 text-center" style=${{ background: 'rgba(255,255,255,0.04)', border: '1px solid rgba(255,255,255,0.06)' }}>
                  <div className="text-justo-400 mb-2 flex justify-center"><svg className="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg></div>
                  <p className="text-sm font-semibold text-white">Mayor visibilidad</p>
                  <p className="text-xs text-gray-500 mt-0.5">Mas clientes te encuentran</p>
                </div>
                <div className="rounded-xl p-4 text-center" style=${{ background: 'rgba(255,255,255,0.04)', border: '1px solid rgba(255,255,255,0.06)' }}>
                  <div className="text-emerald-400 mb-2 flex justify-center"><svg className="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                  <p className="text-sm font-semibold text-white">Descuento 2do mes</p>
                  <p className="text-xs text-gray-500 mt-0.5">Ahorra en tu segundo mes</p>
                </div>
              </div>

              ${totalReferrals > 0 && html`<div className="flex items-center justify-center gap-2 text-sm text-gray-400">
                <svg className="h-4 w-4 text-emerald-400" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd"/></svg>
                <span>${totalReferrals} ${totalReferrals === 1 ? 'restaurante ya se unio' : 'restaurantes ya se unieron'} con Justo</span>
              </div>`}

              <button onClick=${function() { setStep(1); }} className="w-full btn-primary py-3.5 text-lg shadow-md shadow-justo-500/25">Reclamar mi beneficio</button>

              <p className="text-center text-xs text-gray-500">Registro en menos de 2 minutos · Ya tienes cuenta? <a href="#/login" className="text-justo-400 font-medium hover:underline">Inicia sesion</a></p>
            </div>
          </div>
        </div>
      </div>`;

      // Step 1: Restaurant info
      if (step === 1) return html`<div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
        <${BackgroundBeams} />
        <${FloatingOrbs} />
        <div className="w-full max-w-lg relative z-10">
          <div className="text-center mb-6">
            <h1 className="text-4xl font-bold text-gradient">Justo</h1>
          </div>
          <div className="glass rounded-2xl p-8">
            ${stepBar}
            <div className="text-center mb-6">
              <div className="inline-flex items-center justify-center w-14 h-14 rounded-full bg-ocean-500/15 border border-ocean-500/20 text-ocean-400 mb-3">
                <svg className="h-7 w-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
              </div>
              <h2 className="text-xl font-bold text-white">Datos de tu restaurante</h2>
              <p className="text-sm text-gray-400 mt-1">Cuentanos sobre tu negocio</p>
            </div>
            <form onSubmit=${function(e) { e.preventDefault(); if (form.restaurantName.trim()) setStep(2); }} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1">Nombre del Restaurante</label>
                <input type="text" required value=${form.restaurantName} onInput=${function(e) { setForm(Object.assign({}, form, { restaurantName: e.target.value })); }}
                  className="input-dark input-dark-lg" placeholder="Ej: Tacos El Rey" autofocus />
              </div>
              <div className="flex gap-3 pt-2">
                <button type="button" onClick=${function() { setStep(0); }} className="flex-1 border border-white/10 text-gray-300 font-medium py-2.5 rounded-lg transition-colors hover:bg-white/5">Atras</button>
                <button type="submit" className="flex-1 btn-primary py-2.5">Continuar</button>
              </div>
            </form>
          </div>
        </div>
      </div>`;

      // Step 2: Account creation
      return html`<div className="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
        <${BackgroundBeams} />
        <${FloatingOrbs} />
        <div className="w-full max-w-lg relative z-10">
          <div className="text-center mb-6">
            <h1 className="text-4xl font-bold text-gradient">Justo</h1>
          </div>
          <div className="glass rounded-2xl p-8">
            ${stepBar}
            <div className="text-center mb-6">
              <div className="inline-flex items-center justify-center w-14 h-14 rounded-full bg-emerald-500/15 border border-emerald-500/20 text-emerald-400 mb-3">
                <svg className="h-7 w-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
              </div>
              <h2 className="text-xl font-bold text-white">Crea tu cuenta</h2>
              <p className="text-sm text-gray-400 mt-1">Ultimo paso para registrar <span className="font-medium text-white">${form.restaurantName}</span></p>
            </div>
            <form onSubmit=${handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1">Tu Nombre</label>
                <input type="text" required value=${form.name} onInput=${function(e) { setForm(Object.assign({}, form, { name: e.target.value })); }}
                  className="input-dark" placeholder="Tu nombre completo" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1">Email</label>
                <input type="email" required value=${form.email} onInput=${function(e) { setForm(Object.assign({}, form, { email: e.target.value })); }}
                  className="input-dark" placeholder="tu@email.com" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-1">Contrasena</label>
                <input type="password" required minLength=${8} value=${form.password} onInput=${function(e) { setForm(Object.assign({}, form, { password: e.target.value })); }}
                  className="input-dark" placeholder="Min. 8 caracteres" />
                <${PasswordStrength} value=${form.password} />
              </div>
              ${error && html`<p className="text-red-400 text-sm" role="alert">${error}</p>`}
              <div className="flex gap-3 pt-2">
                <button type="button" onClick=${function() { setStep(1); }} className="flex-1 border border-white/10 text-gray-300 font-medium py-2.5 rounded-lg transition-colors hover:bg-white/5">Atras</button>
                <button type="submit" disabled=${loading} className="flex-1 btn-primary py-2.5 flex items-center justify-center">
                  ${loading ? html`<${Spinner} className="h-5 w-5" />` : 'Registrar Restaurante'}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>`;
    }

    // ─── Layout ──────────────────────────────────────────
    function Layout(props) {
      var auth = useAuth();
      var hash = useHash();
      var _m = useState(false), mobileOpen = _m[0], setMobileOpen = _m[1];

      var navItems = [
        { path: '/', label: 'Dashboard', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0h4' },
        { path: '/referidos', label: 'Referidos', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z' },
        { path: '/registrar-restaurante', label: 'Registrar Restaurante', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4' },
        { path: '/recompensas', label: 'Recompensas', icon: 'M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
      ];
      if (auth.isAdmin) navItems.push({ path: '/admin', label: 'Admin', icon: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z' });

      function isActive(path) { return path === '/' ? hash === '/' : hash.indexOf(path) === 0; }

      var sidebar = html`<div className="flex flex-col h-full">
        <div className="p-6">
          <h1 className="text-2xl font-bold text-gradient">Justo</h1>
          <p className="text-gray-500 text-xs mt-1">Programa de Referidos</p>
        </div>
        <nav className="flex-1 px-3 space-y-1" aria-label="Navegacion principal">
          ${navItems.map(function(item) {
            return html`<${NavLink} key=${item.path} to=${item.path} onClick=${function() { setMobileOpen(false); }}
              className=${'flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ' + (isActive(item.path) ? 'nav-glow bg-white/[0.08] text-white' : 'text-gray-400 hover:bg-white/[0.04] hover:text-white')}
              aria-current=${isActive(item.path) ? 'page' : undefined}>
              <svg className="h-5 w-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d=${item.icon}/></svg>
              ${item.label}
            </${NavLink}>`;
          })}
        </nav>
        <div className="p-4 border-t border-white/[0.06]">
          <div className="flex items-center">
            <div className="w-8 h-8 rounded-full bg-gradient-to-br from-justo-500 to-ocean-500 flex items-center justify-center text-white text-sm font-bold">${auth.user && auth.user.name && auth.user.name[0].toUpperCase()}</div>
            <div className="ml-3 flex-1 min-w-0">
              <p className="text-sm font-medium text-white truncate">${auth.user && auth.user.name}</p>
              <p className="text-xs text-gray-500 truncate">${auth.user && auth.user.email}</p>
            </div>
          </div>
          <button onClick=${function() { auth.logout(); navigate('/login'); }} className="mt-3 w-full text-left text-sm text-gray-500 hover:text-white transition-colors">Cerrar sesion</button>
        </div>
      </div>`;

      // Route the page content
      var page;
      if (hash === '/' || hash === '') page = html`<${Dashboard} />`;
      else if (hash === '/referidos') page = html`<${Referrals} />`;
      else if (hash === '/registrar-restaurante') page = html`<${RegisterRestaurant} />`;
      else if (hash === '/recompensas') page = html`<${Rewards} />`;
      else if (hash === '/admin' && auth.isAdmin) page = html`<${AdminPanel} />`;
      else page = html`<${Dashboard} />`;

      return html`<div className="flex h-screen overflow-hidden">
        <div className="hidden md:flex md:w-64 md:flex-col noise" style=${{ background: 'linear-gradient(to bottom, #0d0a1f, #080818)' }}>${sidebar}</div>
        ${mobileOpen && html`<div className="fixed inset-0 z-40 md:hidden">
          <div className="fixed inset-0 bg-black/60 backdrop-blur-sm" onClick=${function() { setMobileOpen(false); }} />
          <div className="fixed inset-y-0 left-0 w-64 z-50 noise" style=${{ background: 'linear-gradient(to bottom, #0d0a1f, #080818)' }}>${sidebar}</div>
        </div>`}
        <div className="flex-1 flex flex-col overflow-hidden">
          <header className="md:hidden px-4 py-3 flex items-center border-b border-white/[0.06]" style=${{ background: '#0a0a18' }}>
            <button onClick=${function() { setMobileOpen(true); }} className="text-gray-400 hover:text-white" aria-label="Abrir menu">
              <svg className="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
            <h1 className="ml-3 text-lg font-bold text-gradient">Justo</h1>
          </header>
          <main className="flex-1 overflow-y-auto p-4 md:p-8" role="main">
            <div className="max-w-6xl mx-auto fade-in">${page}</div>
          </main>
        </div>
      </div>`;
    }

    // ─── App ─────────────────────────────────────────────
    function App() {
      var auth = useAuth();
      var hash = useHash();
      var toast = useToast();

      if (auth.loading) return html`<${LoadingScreen} />`;

      // Public invite page (no auth required)
      if (hash.indexOf('/invite/') === 0) {
        var inviteCode = hash.split('/invite/')[1];
        if (auth.user) { toast.addToast('Ya tienes una cuenta activa', 'warning'); navigate('/'); return null; }
        return html`<${InvitePage} code=${inviteCode} />`;
      }

      if (!auth.user && hash !== '/login') { navigate('/login'); return null; }
      if (hash === '/login') return html`<${AuthPage} />`;
      return html`<${Layout} />`;
    }

    // ─── Mount ───────────────────────────────────────────
    var root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(html`<${ErrorBoundary}><${AuthProvider}><${ToastProvider}><${App} /></${ToastProvider}></${AuthProvider}></${ErrorBoundary}>`);

    // Set default hash
    if (!window.location.hash) window.location.hash = '/';
  </script>
</body>
</html>
