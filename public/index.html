<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Justo - Programa de Referidos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            justo: {
              50: '#f5f3ff', 100: '#ede9fe', 200: '#ddd6fe', 300: '#c4b5fd',
              400: '#a78bfa', 500: '#7c3aed', 600: '#6d28d9', 700: '#5b21b6',
              800: '#4c1d95', 900: '#3b0764',
            },
            ocean: {
              50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd',
              400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8',
            }
          }
        }
      }
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="root"></div>

  <script>
    window.onerror = function(msg, url, line, col) {
      document.getElementById('root').innerHTML = '<pre style="color:red;padding:20px;font-size:14px">' + msg + '\nat ' + url + ':' + line + ':' + col + '</pre>';
    };
  </script>
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/htm@3.1.1/dist/htm.js"></script>

  <script>
    var html = htm.bind(React.createElement);
    var useState = React.useState, useEffect = React.useEffect, useContext = React.useContext,
        createContext = React.createContext, useCallback = React.useCallback;

    // ─── Simple Hash Router ─────────────────────────────
    function useHash() {
      var _s = useState(window.location.hash.slice(1) || '/');
      var hash = _s[0], setHash = _s[1];
      useEffect(function() {
        function onHash() { setHash(window.location.hash.slice(1) || '/'); }
        window.addEventListener('hashchange', onHash);
        return function() { window.removeEventListener('hashchange', onHash); };
      }, []);
      return hash;
    }
    function navigate(path) { window.location.hash = path; }

    // ─── API Helper ──────────────────────────────────────
    function api(path, options) {
      options = options || {};
      var token = localStorage.getItem('justo_token');
      var config = {
        headers: Object.assign({ 'Content-Type': 'application/json' }, token ? { Authorization: 'Bearer ' + token } : {}),
      };
      Object.keys(options).forEach(function(k) {
        if (k === 'headers') config.headers = Object.assign(config.headers, options.headers);
        else config[k] = options[k];
      });
      return fetch(path, config).then(function(res) {
        return res.json().then(function(data) {
          if (!res.ok) {
            if (res.status === 401) {
              localStorage.removeItem('justo_token');
              localStorage.removeItem('justo_user');
              navigate('/login');
            }
            throw new Error((data.error && data.error.message) || 'Error del servidor');
          }
          return data;
        });
      });
    }

    // ─── Auth Context ────────────────────────────────────
    var AuthContext = createContext(null);

    function AuthProvider(props) {
      var _u = useState(null), user = _u[0], setUser = _u[1];
      var _t = useState(null), token = _t[0], setToken = _t[1];
      var _l = useState(true), loading = _l[0], setLoading = _l[1];

      useEffect(function() {
        var t = localStorage.getItem('justo_token');
        var u = localStorage.getItem('justo_user');
        if (t && u) { setToken(t); setUser(JSON.parse(u)); }
        setLoading(false);
      }, []);

      function login(userData, tokenStr) {
        setUser(userData); setToken(tokenStr);
        localStorage.setItem('justo_token', tokenStr);
        localStorage.setItem('justo_user', JSON.stringify(userData));
      }
      function logout() {
        setUser(null); setToken(null);
        localStorage.removeItem('justo_token');
        localStorage.removeItem('justo_user');
      }

      return html`<${AuthContext.Provider} value=${{ user: user, token: token, loading: loading, login: login, logout: logout, isAdmin: user && user.role === 'ADMIN' }}>
        ${props.children}
      </${AuthContext.Provider}>`;
    }

    function useAuth() { return useContext(AuthContext); }

    // ─── Toast Context ───────────────────────────────────
    var ToastContext = createContext(null);

    function ToastProvider(props) {
      var _s = useState([]), toasts = _s[0], setToasts = _s[1];
      function addToast(message, type) {
        type = type || 'success';
        var id = Date.now();
        setToasts(function(prev) { return prev.concat([{ id: id, message: message, type: type }]); });
        setTimeout(function() { setToasts(function(prev) { return prev.filter(function(t) { return t.id !== id; }); }); }, 4000);
      }
      return html`<${ToastContext.Provider} value=${{ addToast: addToast }}>
        ${props.children}
        <div className="fixed top-4 right-4 z-50 space-y-2">
          ${toasts.map(function(t) {
            return html`<div key=${t.id} className=${'fade-in px-4 py-3 rounded-lg shadow-lg text-white text-sm font-medium ' + (t.type === 'error' ? 'bg-red-500' : t.type === 'warning' ? 'bg-yellow-500' : 'bg-green-500')}>
              ${t.message}
            </div>`;
          })}
        </div>
      </${ToastContext.Provider}>`;
    }

    function useToast() { return useContext(ToastContext); }

    // ─── Utility Components ──────────────────────────────
    function StatusBadge(props) {
      var map = {
        PENDING: ['Pendiente', 'bg-yellow-100 text-yellow-800'],
        QUALIFIED: ['Calificado', 'bg-blue-100 text-blue-800'],
        REWARDED: ['Recompensado', 'bg-green-100 text-green-800'],
        EXPIRED: ['Expirado', 'bg-gray-100 text-gray-600'],
        ISSUED: ['Disponible', 'bg-green-100 text-green-800'],
        REDEEMED: ['Canjeado', 'bg-blue-100 text-blue-800'],
      };
      var entry = map[props.status] || [props.status, 'bg-gray-100 text-gray-600'];
      return html`<span className=${'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ' + entry[1]}>${entry[0]}</span>`;
    }

    function Spinner(props) {
      var cls = props.className || 'h-5 w-5';
      return html`<svg className=${'animate-spin ' + cls} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"/><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>`;
    }

    function LoadingScreen() {
      return html`<div className="flex items-center justify-center h-screen"><${Spinner} className="h-8 w-8 text-justo-500" /><span className="ml-3 text-gray-500">Cargando...</span></div>`;
    }

    function EmptyState(props) {
      return html`<div className="text-center py-12">
        <div className="text-gray-300 mb-4"><svg className="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/></svg></div>
        <h3 className="text-lg font-medium text-gray-900">${props.title}</h3>
        <p className="text-gray-500 mt-1 text-sm">${props.description}</p>
      </div>`;
    }

    // ─── Nav Link ─────────────────────────────────────────
    function NavLink(props) {
      return html`<a href=${'#' + props.to} onClick=${props.onClick || null}
        className=${props.className}>${props.children}</a>`;
    }

    // ─── Auth Page ───────────────────────────────────────
    function AuthPage() {
      var auth = useAuth();
      var _m = useState('login'), mode = _m[0], setMode = _m[1];
      var _f = useState({ name: '', email: '', password: '' }), form = _f[0], setForm = _f[1];
      var _ld = useState(false), loading = _ld[0], setLoading = _ld[1];
      var _e = useState(''), error = _e[0], setError = _e[1];
      var toast = useToast();

      if (auth.user) { navigate('/'); return null; }

      function handleSubmit(e) {
        e.preventDefault();
        setError(''); setLoading(true);
        var endpoint = mode === 'login' ? '/auth/login' : '/auth/register';
        var body = mode === 'login' ? { email: form.email, password: form.password } : form;
        api(endpoint, { method: 'POST', body: JSON.stringify(body) })
          .then(function(data) {
            auth.login(data.user, data.token);
            toast.addToast(mode === 'login' ? 'Bienvenido de vuelta!' : 'Cuenta creada exitosamente!');
            navigate('/');
          })
          .catch(function(err) { setError(err.message); })
          .finally(function() { setLoading(false); });
      }

      return html`<div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-justo-600 to-ocean-600 p-4">
        <div className="w-full max-w-md">
          <div className="text-center mb-8">
            <h1 className="text-4xl font-bold text-white">Justo</h1>
            <p className="text-white/80 mt-2">Programa de Referidos</p>
          </div>
          <div className="bg-white rounded-2xl shadow-xl p-8">
            <div className="flex bg-gray-100 rounded-lg p-1 mb-6">
              <button onClick=${function() { setMode('login'); setError(''); }} className=${'flex-1 py-2 text-sm font-medium rounded-md transition-colors ' + (mode === 'login' ? 'bg-white shadow text-justo-600' : 'text-gray-500')}>Iniciar Sesion</button>
              <button onClick=${function() { setMode('register'); setError(''); }} className=${'flex-1 py-2 text-sm font-medium rounded-md transition-colors ' + (mode === 'register' ? 'bg-white shadow text-justo-600' : 'text-gray-500')}>Registrarse</button>
            </div>
            <form onSubmit=${handleSubmit} className="space-y-4">
              ${mode === 'register' && html`<div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                <input type="text" required value=${form.name} onInput=${function(e) { setForm(Object.assign({}, form, { name: e.target.value })); }} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-justo-500 focus:border-transparent outline-none" placeholder="Tu nombre" />
              </div>`}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <input type="email" required value=${form.email} onInput=${function(e) { setForm(Object.assign({}, form, { email: e.target.value })); }} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-justo-500 focus:border-transparent outline-none" placeholder="tu@email.com" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Contrasena</label>
                <input type="password" required minLength=${6} value=${form.password} onInput=${function(e) { setForm(Object.assign({}, form, { password: e.target.value })); }} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-justo-500 focus:border-transparent outline-none" placeholder="Min. 6 caracteres" />
              </div>
              ${error && html`<p className="text-red-500 text-sm">${error}</p>`}
              <button type="submit" disabled=${loading} className="w-full bg-justo-500 hover:bg-justo-600 disabled:opacity-50 text-white font-medium py-2.5 rounded-lg transition-colors flex items-center justify-center">
                ${loading ? html`<${Spinner} className="h-5 w-5" />` : (mode === 'login' ? 'Iniciar Sesion' : 'Crear Cuenta')}
              </button>
            </form>
          </div>
        </div>
      </div>`;
    }

    // ─── Dashboard ───────────────────────────────────────
    function Dashboard() {
      var auth = useAuth();
      var toast = useToast();
      var _c = useState(null), code = _c[0], setCode = _c[1];
      var _s = useState([]), sent = _s[0], setSent = _s[1];
      var _r = useState([]), rewards = _r[0], setRewards = _r[1];
      var _l = useState(true), loading = _l[0], setLoading = _l[1];

      useEffect(function() {
        Promise.all([api('/referrals/my-code'), api('/referrals/sent'), api('/rewards')])
          .then(function(res) { setCode(res[0]); setSent(res[1]); setRewards(res[2]); })
          .catch(function() {})
          .finally(function() { setLoading(false); });
      }, []);

      function copyCode() {
        if (!code) return;
        var link = window.location.origin + '/#/invite/' + code.code;
        navigator.clipboard.writeText(link).then(function() { toast.addToast('Link copiado!'); });
      }

      function shareWhatsApp() {
        if (!code) return;
        var link = window.location.origin + '/#/invite/' + code.code;
        var msg = 'Te invito a unirte a Justo! Registra tu restaurante con mi link: ' + link;
        window.open('https://wa.me/?text=' + encodeURIComponent(msg), '_blank');
      }

      function shareEmail() {
        if (!code) return;
        var link = window.location.origin + '/#/invite/' + code.code;
        var subject = 'Te invito a Justo - Programa de Referidos';
        var body = 'Hola!\n\nTe invito a registrar tu restaurante en Justo. Usa mi link de referido para obtener beneficios:\n\n' + link + '\n\nSaludos!';
        window.location.href = 'mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
      }

      if (loading) return html`<${LoadingScreen} />`;

      var activeRewards = rewards.filter(function(r) { return r.status === 'ISSUED'; }).length;
      var redeemedRewards = rewards.filter(function(r) { return r.status === 'REDEEMED'; }).length;

      return html`<div className="space-y-6">
        <h2 className="text-2xl font-bold text-gray-900">Hola, ${auth.user.name}</h2>

        <div className="bg-gradient-to-r from-justo-500 to-ocean-500 rounded-2xl p-6 text-white shadow-lg">
          <p className="text-sm text-white/80 mb-2">Tu codigo de referido</p>
          <div className="flex items-center justify-between flex-wrap gap-4">
            <span className="text-3xl md:text-4xl font-bold tracking-wider">${code ? code.code : '...'}</span>
            <div className="flex gap-2 flex-wrap">
              <button onClick=${copyCode} className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium transition-colors backdrop-blur-sm flex items-center gap-1.5">
                <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                Copiar Link
              </button>
              <button onClick=${shareWhatsApp} className="bg-green-500/80 hover:bg-green-500 px-4 py-2 rounded-lg text-sm font-medium transition-colors backdrop-blur-sm flex items-center gap-1.5">
                <svg className="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                WhatsApp
              </button>
              <button onClick=${shareEmail} className="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium transition-colors backdrop-blur-sm flex items-center gap-1.5">
                <svg className="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                Email
              </button>
            </div>
          </div>
          ${code && html`<p className="text-white/70 text-sm mt-3">Usado ${code.useCount} ${code.useCount === 1 ? 'vez' : 'veces'}</p>`}
        </div>

        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <p className="text-sm text-gray-500">Referidos Enviados</p>
            <p className="text-3xl font-bold text-gray-900 mt-1">${sent.length}</p>
          </div>
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <p className="text-sm text-gray-500">Recompensas Activas</p>
            <p className="text-3xl font-bold text-green-600 mt-1">${activeRewards}</p>
          </div>
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
            <p className="text-sm text-gray-500">Recompensas Canjeadas</p>
            <p className="text-3xl font-bold text-blue-600 mt-1">${redeemedRewards}</p>
          </div>
        </div>

        <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">Actividad Reciente</h3>
          ${sent.length === 0
            ? html`<p className="text-gray-500 text-sm">Aun no has referido a nadie. Comparte tu codigo!</p>`
            : html`<div className="space-y-3">
                ${sent.slice(0, 5).map(function(r) {
                  return html`<div key=${r.id} className="flex items-center justify-between py-2 border-b border-gray-50 last:border-0">
                    <div>
                      <p className="text-sm font-medium text-gray-900">${r.referredRestaurant.name}</p>
                      <p className="text-xs text-gray-500">${new Date(r.createdAt).toLocaleDateString('es-MX')}</p>
                    </div>
                    <${StatusBadge} status=${r.status} />
                  </div>`;
                })}
              </div>`}
        </div>
      </div>`;
    }

    // ─── Referrals ───────────────────────────────────────
    function Referrals() {
      var _t = useState('sent'), tab = _t[0], setTab = _t[1];
      var _s = useState([]), sent = _s[0], setSent = _s[1];
      var _r = useState(null), received = _r[0], setReceived = _r[1];
      var _l = useState(true), loading = _l[0], setLoading = _l[1];

      useEffect(function() {
        Promise.all([api('/referrals/sent'), api('/referrals/received')])
          .then(function(res) { setSent(res[0]); setReceived(res[1]); })
          .catch(function() {})
          .finally(function() { setLoading(false); });
      }, []);

      if (loading) return html`<${LoadingScreen} />`;

      return html`<div className="space-y-6">
        <h2 className="text-2xl font-bold text-gray-900">Referidos</h2>
        <div className="flex bg-gray-100 rounded-lg p-1 w-fit">
          <button onClick=${function() { setTab('sent'); }} className=${'px-4 py-2 text-sm font-medium rounded-md transition-colors ' + (tab === 'sent' ? 'bg-white shadow text-justo-600' : 'text-gray-500')}>Mis Referidos (${sent.length})</button>
          <button onClick=${function() { setTab('received'); }} className=${'px-4 py-2 text-sm font-medium rounded-md transition-colors ' + (tab === 'received' ? 'bg-white shadow text-justo-600' : 'text-gray-500')}>Mi Referido</button>
        </div>

        ${tab === 'sent' && html`<div className="bg-white rounded-xl shadow-sm border border-gray-100">
          ${sent.length === 0
            ? html`<${EmptyState} title="Sin referidos" description="Comparte tu codigo para empezar a referir restaurantes." />`
            : html`<div className="overflow-x-auto"><table className="w-full">
                <thead><tr className="border-b border-gray-100">
                  <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Restaurante</th>
                  <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Estado</th>
                  <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Fecha</th>
                </tr></thead>
                <tbody>${sent.map(function(r) {
                  return html`<tr key=${r.id} className="border-b border-gray-50 last:border-0">
                    <td className="px-6 py-4 text-sm font-medium text-gray-900">${r.referredRestaurant.name}</td>
                    <td className="px-6 py-4"><${StatusBadge} status=${r.status} /></td>
                    <td className="px-6 py-4 text-sm text-gray-500">${new Date(r.createdAt).toLocaleDateString('es-MX')}</td>
                  </tr>`;
                })}</tbody>
              </table></div>`}
        </div>`}

        ${tab === 'received' && html`<div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          ${received
            ? html`<div className="space-y-3">
                <p className="text-sm text-gray-500">Fuiste referido por</p>
                <p className="text-xl font-semibold text-gray-900">${received.referralCode && received.referralCode.referrer && received.referralCode.referrer.name}</p>
                <p className="text-sm text-gray-500">Codigo usado: <span className="font-mono text-justo-600">${received.referralCode && received.referralCode.code}</span></p>
                <div className="pt-2"><${StatusBadge} status=${received.status} /></div>
              </div>`
            : html`<${EmptyState} title="No fuiste referido" description="Puedes registrar tu restaurante con un codigo de referido." />`}
        </div>`}
      </div>`;
    }

    // ─── Register Restaurant ─────────────────────────────
    function RegisterRestaurant() {
      var toast = useToast();
      var _n = useState(''), name = _n[0], setName = _n[1];
      var _rc = useState(''), refCode = _rc[0], setRefCode = _rc[1];
      var _cs = useState(null), codeStatus = _cs[0], setCodeStatus = _cs[1];
      var _rn = useState(''), referrerName = _rn[0], setReferrerName = _rn[1];
      var _ce = useState(''), codeError = _ce[0], setCodeError = _ce[1];
      var _ld = useState(false), loading = _ld[0], setLoading = _ld[1];
      var _e = useState(''), error = _e[0], setError = _e[1];

      useEffect(function() {
        if (!refCode || refCode.length < 4) { setCodeStatus(null); return; }
        setCodeStatus('validating');
        var timer = setTimeout(function() {
          api('/referrals/validate/' + encodeURIComponent(refCode))
            .then(function(data) { setCodeStatus('valid'); setReferrerName(data.referrerName); setCodeError(''); })
            .catch(function(err) { setCodeStatus('invalid'); setCodeError(err.message); });
        }, 500);
        return function() { clearTimeout(timer); };
      }, [refCode]);

      function handleSubmit(e) {
        e.preventDefault();
        setError(''); setLoading(true);
        var body = { name: name };
        if (refCode) body.referralCode = refCode;
        api('/restaurants/register', { method: 'POST', body: JSON.stringify(body) })
          .then(function() { toast.addToast('Restaurante registrado exitosamente!'); navigate('/'); })
          .catch(function(err) { setError(err.message); })
          .finally(function() { setLoading(false); });
      }

      return html`<div className="max-w-lg mx-auto space-y-6">
        <h2 className="text-2xl font-bold text-gray-900">Registrar Restaurante</h2>
        <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
          <form onSubmit=${handleSubmit} className="space-y-5">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Nombre del Restaurante</label>
              <input type="text" required value=${name} onInput=${function(e) { setName(e.target.value); }} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-justo-500 focus:border-transparent outline-none" placeholder="Ej: Tacos El Rey" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Codigo de Referido <span className="text-gray-400">(opcional)</span></label>
              <div className="relative">
                <input type="text" value=${refCode} onInput=${function(e) { setRefCode(e.target.value.toUpperCase()); }} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-justo-500 focus:border-transparent outline-none font-mono" placeholder="JUSTO-XXXXXXXX" />
                ${codeStatus === 'validating' && html`<div className="absolute right-3 top-2.5"><${Spinner} className="h-5 w-5 text-gray-400" /></div>`}
                ${codeStatus === 'valid' && html`<div className="absolute right-3 top-2.5 text-green-500"><svg className="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 13l4 4L19 7"/></svg></div>`}
                ${codeStatus === 'invalid' && html`<div className="absolute right-3 top-2.5 text-red-500"><svg className="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"/></svg></div>`}
              </div>
              ${codeStatus === 'valid' && html`<p className="text-green-600 text-sm mt-1">Referido por ${referrerName}</p>`}
              ${codeStatus === 'invalid' && html`<p className="text-red-500 text-sm mt-1">${codeError}</p>`}
            </div>
            ${error && html`<p className="text-red-500 text-sm">${error}</p>`}
            <button type="submit" disabled=${loading} className="w-full bg-justo-500 hover:bg-justo-600 disabled:opacity-50 text-white font-medium py-2.5 rounded-lg transition-colors flex items-center justify-center">
              ${loading ? html`<${Spinner} className="h-5 w-5" />` : 'Registrar Restaurante'}
            </button>
          </form>
        </div>
      </div>`;
    }

    // ─── Rewards ─────────────────────────────────────────
    function Rewards() {
      var toast = useToast();
      var _r = useState([]), rewards = _r[0], setRewards = _r[1];
      var _l = useState(true), loading = _l[0], setLoading = _l[1];
      var _ri = useState(null), redeemingId = _ri[0], setRedeemingId = _ri[1];

      useEffect(function() {
        api('/rewards').then(setRewards).catch(function() {}).finally(function() { setLoading(false); });
      }, []);

      function redeem(id) {
        setRedeemingId(id);
        api('/rewards/' + id + '/redeem', { method: 'POST' })
          .then(function(updated) {
            setRewards(function(prev) { return prev.map(function(r) { return r.id === id ? Object.assign({}, r, updated) : r; }); });
            toast.addToast('Recompensa canjeada!');
          })
          .catch(function(err) { toast.addToast(err.message, 'error'); })
          .finally(function() { setRedeemingId(null); });
      }

      if (loading) return html`<${LoadingScreen} />`;

      function rewardTitle(r) {
        if (r.beneficiaryType === 'REFERRER') return r.rewardType === 'CREDITS' ? 'Creditos por Referido' : 'Recompensa por Referido';
        return r.rewardType === 'FEE_WAIVER' ? 'Dias sin Comision' : 'Recompensa de Bienvenida';
      }

      return html`<div className="space-y-6">
        <h2 className="text-2xl font-bold text-gray-900">Mis Recompensas</h2>
        ${rewards.length === 0
          ? html`<div className="bg-white rounded-xl shadow-sm border border-gray-100"><${EmptyState} title="Sin recompensas" description="Refiere restaurantes para ganar recompensas." /></div>`
          : html`<div className="grid gap-4">
              ${rewards.map(function(r) {
                return html`<div key=${r.id} className="bg-white rounded-xl shadow-sm border border-gray-100 p-6">
                  <div className="flex items-start justify-between gap-2 mb-2">
                    <h3 className="font-semibold text-gray-900">${rewardTitle(r)}</h3>
                    <${StatusBadge} status=${r.status} />
                  </div>
                  ${r.amount && html`<p className="text-2xl font-bold text-justo-600">$${r.amount}</p>`}
                  ${r.description && html`<p className="text-sm text-gray-600 mt-1">${r.description}</p>`}
                  <div className="flex items-center justify-between mt-3">
                    <p className="text-xs text-gray-400">${r.expiresAt ? 'Vence: ' + new Date(r.expiresAt).toLocaleDateString('es-MX') : ''}</p>
                    ${r.status === 'ISSUED' && html`<button onClick=${function() { redeem(r.id); }} disabled=${redeemingId === r.id}
                      className="bg-justo-500 hover:bg-justo-600 disabled:opacity-50 text-white text-sm font-medium px-4 py-1.5 rounded-lg transition-colors">
                      ${redeemingId === r.id ? html`<${Spinner} className="h-4 w-4" />` : 'Canjear'}
                    </button>`}
                  </div>
                </div>`;
              })}
            </div>`}
      </div>`;
    }

    // ─── Admin Panel ─────────────────────────────────────
    function AdminPanel() {
      var toast = useToast();
      var _r = useState([]), referrals = _r[0], setReferrals = _r[1];
      var _l = useState(true), loading = _l[0], setLoading = _l[1];
      var _f = useState('ALL'), filter = _f[0], setFilter = _f[1];
      var _q = useState(null), qualifyingId = _q[0], setQualifyingId = _q[1];

      useEffect(function() {
        api('/referrals/admin/all').then(setReferrals).catch(function() {}).finally(function() { setLoading(false); });
      }, []);

      function qualify(id) {
        setQualifyingId(id);
        api('/referrals/' + id + '/qualify', { method: 'POST' })
          .then(function() {
            setReferrals(function(prev) { return prev.map(function(r) { return r.id === id ? Object.assign({}, r, { status: 'QUALIFIED' }) : r; }); });
            toast.addToast('Referido calificado!');
          })
          .catch(function(err) { toast.addToast(err.message, 'error'); })
          .finally(function() { setQualifyingId(null); });
      }

      if (loading) return html`<${LoadingScreen} />`;

      var filtered = filter === 'ALL' ? referrals : referrals.filter(function(r) { return r.status === filter; });
      var filters = ['ALL', 'PENDING', 'QUALIFIED', 'REWARDED', 'EXPIRED'];
      var filterLabels = { ALL: 'Todos', PENDING: 'Pendientes', QUALIFIED: 'Calificados', REWARDED: 'Recompensados', EXPIRED: 'Expirados' };

      return html`<div className="space-y-6">
        <h2 className="text-2xl font-bold text-gray-900">Panel de Administracion</h2>
        <div className="flex items-center gap-3 flex-wrap">
          ${filters.map(function(f) {
            return html`<button key=${f} onClick=${function() { setFilter(f); }}
              className=${'px-3 py-1.5 text-sm font-medium rounded-lg transition-colors ' + (filter === f ? 'bg-justo-500 text-white' : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50')}>
              ${filterLabels[f]}${f !== 'ALL' ? ' (' + referrals.filter(function(r) { return r.status === f; }).length + ')' : ''}
            </button>`;
          })}
        </div>
        <div className="bg-white rounded-xl shadow-sm border border-gray-100">
          ${filtered.length === 0
            ? html`<${EmptyState} title="Sin referidos" description="No hay referidos con este filtro." />`
            : html`<div className="overflow-x-auto"><table className="w-full">
                <thead><tr className="border-b border-gray-100">
                  <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Referente</th>
                  <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Restaurante</th>
                  <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Estado</th>
                  <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Fecha</th>
                  <th className="text-left px-6 py-3 text-xs font-medium text-gray-500 uppercase">Acciones</th>
                </tr></thead>
                <tbody>${filtered.map(function(r) {
                  var ref = r.referralCode && r.referralCode.referrer;
                  var rest = r.referredRestaurant;
                  return html`<tr key=${r.id} className="border-b border-gray-50 last:border-0">
                    <td className="px-6 py-4">
                      <p className="text-sm font-medium text-gray-900">${ref && ref.name}</p>
                      <p className="text-xs text-gray-500">${ref && ref.email}</p>
                    </td>
                    <td className="px-6 py-4 text-sm text-gray-900">${rest && rest.name}</td>
                    <td className="px-6 py-4"><${StatusBadge} status=${r.status} /></td>
                    <td className="px-6 py-4 text-sm text-gray-500">${new Date(r.createdAt).toLocaleDateString('es-MX')}</td>
                    <td className="px-6 py-4">
                      ${r.status === 'PENDING' && html`<button onClick=${function() { qualify(r.id); }} disabled=${qualifyingId === r.id}
                        className="bg-ocean-500 hover:bg-ocean-600 disabled:opacity-50 text-white text-xs font-medium px-3 py-1.5 rounded-lg transition-colors">
                        ${qualifyingId === r.id ? html`<${Spinner} className="h-3 w-3" />` : 'Calificar'}
                      </button>`}
                    </td>
                  </tr>`;
                })}</tbody>
              </table></div>`}
        </div>
      </div>`;
    }

    // ─── Invite Page (Public Onboarding) ──────────────
    function InvitePage(props) {
      var auth = useAuth();
      var toast = useToast();
      var code = props.code;
      var _rs = useState('loading'), refStatus = _rs[0], setRefStatus = _rs[1];
      var _rn = useState(''), referrerName = _rn[0], setReferrerName = _rn[1];
      var _f = useState({ name: '', email: '', password: '', restaurantName: '' }), form = _f[0], setForm = _f[1];
      var _ld = useState(false), loading = _ld[0], setLoading = _ld[1];
      var _e = useState(''), error = _e[0], setError = _e[1];

      useEffect(function() {
        if (!code) { setRefStatus('invalid'); return; }
        api('/referrals/validate/' + encodeURIComponent(code))
          .then(function(data) { setRefStatus('valid'); setReferrerName(data.referrerName); })
          .catch(function() { setRefStatus('invalid'); });
      }, [code]);

      function handleSubmit(e) {
        e.preventDefault();
        setError(''); setLoading(true);
        api('/auth/register-with-referral', {
          method: 'POST',
          body: JSON.stringify({
            name: form.name,
            email: form.email,
            password: form.password,
            restaurantName: form.restaurantName,
            referralCode: code
          })
        })
          .then(function(data) {
            auth.login(data.user, data.token);
            toast.addToast('Bienvenido a Justo! Tu restaurante ha sido registrado.');
            navigate('/');
          })
          .catch(function(err) { setError(err.message); })
          .finally(function() { setLoading(false); });
      }

      if (refStatus === 'loading') return html`<${LoadingScreen} />`;

      if (refStatus === 'invalid') return html`<div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-justo-600 to-ocean-600 p-4">
        <div className="w-full max-w-md text-center">
          <div className="bg-white rounded-2xl shadow-xl p-8">
            <div className="text-red-500 mb-4"><svg className="mx-auto h-16 w-16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4.5c-.77-.833-2.694-.833-3.464 0L3.34 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg></div>
            <h2 className="text-xl font-bold text-gray-900 mb-2">Codigo de invitacion invalido</h2>
            <p className="text-gray-500 mb-6">Este link de invitacion no es valido o ha expirado.</p>
            <a href="#/login" className="inline-block bg-justo-500 hover:bg-justo-600 text-white font-medium py-2.5 px-6 rounded-lg transition-colors">Ir a Iniciar Sesion</a>
          </div>
        </div>
      </div>`;

      return html`<div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-justo-600 to-ocean-600 p-4">
        <div className="w-full max-w-md">
          <div className="text-center mb-6">
            <h1 className="text-4xl font-bold text-white">Justo</h1>
            <p className="text-white/80 mt-2">Programa de Referidos</p>
          </div>
          <div className="bg-white rounded-2xl shadow-xl p-8">
            <div className="text-center mb-6">
              <div className="inline-flex items-center justify-center w-14 h-14 rounded-full bg-justo-100 text-justo-600 mb-3">
                <svg className="h-7 w-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.25 2.25 0 11-4.5 0 2.25 2.25 0 014.5 0z"/></svg>
              </div>
              <p className="text-sm text-gray-500">Fuiste invitado por</p>
              <p className="text-xl font-bold text-gray-900">${referrerName}</p>
            </div>
            <div className="border-t border-gray-100 pt-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-4">Crea tu cuenta y registra tu restaurante</h3>
              <form onSubmit=${handleSubmit} className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Tu Nombre</label>
                  <input type="text" required value=${form.name} onInput=${function(e) { setForm(Object.assign({}, form, { name: e.target.value })); }}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-justo-500 focus:border-transparent outline-none" placeholder="Tu nombre completo" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                  <input type="email" required value=${form.email} onInput=${function(e) { setForm(Object.assign({}, form, { email: e.target.value })); }}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-justo-500 focus:border-transparent outline-none" placeholder="tu@email.com" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Contrasena</label>
                  <input type="password" required minLength=${6} value=${form.password} onInput=${function(e) { setForm(Object.assign({}, form, { password: e.target.value })); }}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-justo-500 focus:border-transparent outline-none" placeholder="Min. 6 caracteres" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Nombre del Restaurante</label>
                  <input type="text" required value=${form.restaurantName} onInput=${function(e) { setForm(Object.assign({}, form, { restaurantName: e.target.value })); }}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-justo-500 focus:border-transparent outline-none" placeholder="Ej: Tacos El Rey" />
                </div>
                ${error && html`<p className="text-red-500 text-sm">${error}</p>`}
                <button type="submit" disabled=${loading} className="w-full bg-justo-500 hover:bg-justo-600 disabled:opacity-50 text-white font-medium py-2.5 rounded-lg transition-colors flex items-center justify-center">
                  ${loading ? html`<${Spinner} className="h-5 w-5" />` : 'Unirme a Justo'}
                </button>
              </form>
              <p className="text-center text-sm text-gray-500 mt-4">Ya tienes cuenta? <a href="#/login" className="text-justo-600 font-medium hover:underline">Iniciar Sesion</a></p>
            </div>
          </div>
        </div>
      </div>`;
    }

    // ─── Layout ──────────────────────────────────────────
    function Layout(props) {
      var auth = useAuth();
      var hash = useHash();
      var _m = useState(false), mobileOpen = _m[0], setMobileOpen = _m[1];

      var navItems = [
        { path: '/', label: 'Dashboard', icon: 'M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0h4' },
        { path: '/referidos', label: 'Referidos', icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z' },
        { path: '/registrar-restaurante', label: 'Registrar Restaurante', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4' },
        { path: '/recompensas', label: 'Recompensas', icon: 'M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z' },
      ];
      if (auth.isAdmin) navItems.push({ path: '/admin', label: 'Admin', icon: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z M15 12a3 3 0 11-6 0 3 3 0 016 0z' });

      function isActive(path) { return path === '/' ? hash === '/' : hash.indexOf(path) === 0; }

      var sidebar = html`<div className="flex flex-col h-full">
        <div className="p-6">
          <h1 className="text-2xl font-bold text-white">Justo</h1>
          <p className="text-justo-300 text-xs mt-1">Programa de Referidos</p>
        </div>
        <nav className="flex-1 px-3 space-y-1">
          ${navItems.map(function(item) {
            return html`<${NavLink} key=${item.path} to=${item.path} onClick=${function() { setMobileOpen(false); }}
              className=${'flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition-colors ' + (isActive(item.path) ? 'bg-white/15 text-white' : 'text-justo-200 hover:bg-white/10 hover:text-white')}>
              <svg className="h-5 w-5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d=${item.icon}/></svg>
              ${item.label}
            </${NavLink}>`;
          })}
        </nav>
        <div className="p-4 border-t border-white/10">
          <div className="flex items-center">
            <div className="w-8 h-8 rounded-full bg-justo-400 flex items-center justify-center text-white text-sm font-bold">${auth.user && auth.user.name && auth.user.name[0].toUpperCase()}</div>
            <div className="ml-3 flex-1 min-w-0">
              <p className="text-sm font-medium text-white truncate">${auth.user && auth.user.name}</p>
              <p className="text-xs text-justo-300 truncate">${auth.user && auth.user.email}</p>
            </div>
          </div>
          <button onClick=${function() { auth.logout(); navigate('/login'); }} className="mt-3 w-full text-left text-sm text-justo-300 hover:text-white transition-colors">Cerrar sesion</button>
        </div>
      </div>`;

      // Route the page content
      var page;
      if (hash === '/' || hash === '') page = html`<${Dashboard} />`;
      else if (hash === '/referidos') page = html`<${Referrals} />`;
      else if (hash === '/registrar-restaurante') page = html`<${RegisterRestaurant} />`;
      else if (hash === '/recompensas') page = html`<${Rewards} />`;
      else if (hash === '/admin' && auth.isAdmin) page = html`<${AdminPanel} />`;
      else page = html`<${Dashboard} />`;

      return html`<div className="flex h-screen overflow-hidden">
        <div className="hidden md:flex md:w-64 md:flex-col bg-gradient-to-b from-justo-800 to-justo-900">${sidebar}</div>
        ${mobileOpen && html`<div className="fixed inset-0 z-40 md:hidden">
          <div className="fixed inset-0 bg-black/50" onClick=${function() { setMobileOpen(false); }} />
          <div className="fixed inset-y-0 left-0 w-64 bg-gradient-to-b from-justo-800 to-justo-900 z-50">${sidebar}</div>
        </div>`}
        <div className="flex-1 flex flex-col overflow-hidden">
          <header className="md:hidden bg-white border-b border-gray-200 px-4 py-3 flex items-center">
            <button onClick=${function() { setMobileOpen(true); }} className="text-gray-500 hover:text-gray-700">
              <svg className="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
            <h1 className="ml-3 text-lg font-bold text-justo-700">Justo</h1>
          </header>
          <main className="flex-1 overflow-y-auto p-4 md:p-8">
            <div className="max-w-6xl mx-auto fade-in">${page}</div>
          </main>
        </div>
      </div>`;
    }

    // ─── App ─────────────────────────────────────────────
    function App() {
      var auth = useAuth();
      var hash = useHash();

      if (auth.loading) return html`<${LoadingScreen} />`;

      // Public invite page (no auth required)
      if (hash.indexOf('/invite/') === 0) {
        var inviteCode = hash.split('/invite/')[1];
        if (auth.user) { navigate('/'); return null; }
        return html`<${InvitePage} code=${inviteCode} />`;
      }

      if (!auth.user && hash !== '/login') { navigate('/login'); return null; }
      if (hash === '/login') return html`<${AuthPage} />`;
      return html`<${Layout} />`;
    }

    // ─── Mount ───────────────────────────────────────────
    var root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(html`<${AuthProvider}><${ToastProvider}><${App} /></${ToastProvider}></${AuthProvider}>`);

    // Set default hash
    if (!window.location.hash) window.location.hash = '/';
  </script>
</body>
</html>
